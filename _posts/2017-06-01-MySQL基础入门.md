---
layout: post
categories: MySQL
description: none
keywords: MySQL
---
# MySQL基础入门
先从MySQL源代码开始MySQL的历程吧，这是理解MySQL架构体系和技术细节最靠谱的途径。

## 源码组织结构
MySQL数据库是开源的，它的源代码可以在其官网上直接获得。我们选择版本是MySQL 5.7.16。

下载之后的文件一般是 mysql-5.7.16.tar.gz（以5.7.16为例）的打包文件，解压之后，可以看到最原始的代码结构。

下面是源码根目录中主要目录及文件的作用。

## MySQL启动过程
想要比较快速地了解MySQL源码，必须要让自己的学习步骤有一个比较清晰的脉络。它作为一个服务器，肯定会在启动之后一直处于运行状态，并且肯定有专门的线程一直监听客户端的连接及操作，这是一个基本的架构。那么，阅读代码时就首先根据这个脉络，有目的地去寻找，看看具体是如何实现的，当你找到它们的实现方法之后，也许会豁然开朗。

那么，首先看一下它的启动过程，看看它究竟干了些什么事情。mysqld服务器是C++语言生成的可执行文件，main函数是其总的入口函数，程序从这里开始，那我们也从这里开始。入口函数在sql/main.cc文件中。找到之后发现，这个文件中只有这一个函数，它又调用了mysqld_main，从这个函数开始到结束，就完成了mysqld的启动操作。
```
/* 
  main() for mysqld.
  Calls mysqld_main() entry point exported by sql library.
*/
extern int mysqld_main(int argc, char **argv);

int main(int argc, char **argv)
{
  return mysqld_main(argc, argv);
}
```
可以看出，所有操作都在mysqld_main中完成。下面这段代码，就是对MySQL入口函数mysqld_main做了精减，并保留了重要操作之后的样子，大概可以知道，在做完下面这些操作之后，MySQL服务器就启动成功了。下面就这些代码，分别在注释处解释了它们的作用
```
int mysqld_main(int argc, char **argv)
{
    my_progname= argv[0];
    orig_argc= argc;
    orig_argv= argv;

    /* 处理配置文件及启动参数 */
    if (load_defaults(MYSQL_CONFIG_NAME, load_default_groups, &argc, &argv))
    {
        flush_error_log_messages();
        return 1;
    }
    sys_var_init();

    /* 继续处理参数变量 */
    ho_error= handle_options(&remaining_argc, &remaining_argv,
                           &all_early_options[0], mysqld_get_one_option);
    mysql_audit_initialize();

    /* 日志系统初始化 */
    query_logger.init();    // 书上是 logger.init_base();

    /* 初始化很多系统内部变量 */
    if (init_common_variables())
        unireg_abort(MYSQLD_ABORT_EXIT);        // Will do exit

    /* 信号系统初始化 */
    my_init_signals();

    /* 核心模块启动，包括存储引擎等 */
    if (init_server_components())
        unireg_abort(MYSQLD_ABORT_EXIT);
    if (init_ssl())
        unireg_abort(MYSQLD_ABORT_EXIT);

    /* 终端重定向处理 */
    reopen_fstream();

    /* 网络系统初始化 */
    if (network_init())
        unireg_abort(MYSQLD_ABORT_EXIT);
    start_signal_handler();     // Creates pidfile
    if (!opt_noacl)
    {
        udf_init();     // 书中是 (void) grant_init();
    }

    /* 状态变量初始化 */
    init_status_vars();

    /* Binlog相关检查初始化 */
    check_binlog_cache_size(NULL);
    check_binlog_stmt_cache_size(NULL);
    binlog_unsafe_map_init();
    if (!opt_bootstrap)
    {
        set_slave_skip_errors(&opt_slave_skip_errors);
        if (server_id != 0)
            init_slave(); /* Ignoring errors while configuring replication. */
    }
    create_shutdown_thread();
    start_handle_manager();

    /* 服务监听线程创建 */
    setup_conn_event_handler_threads();     // 书上是 handle_connections_sockets();
    /* Wait until cleanup is done
    从这里开始，服务器启动线程一直等待，直到shutdown后，继续向下执行*/
    mysql_mutex_lock(&LOCK_socket_listener_active);
    socket_listener_active= false;
    mysql_cond_broadcast(&COND_socket_listener_active);
    mysql_mutex_unlock(&LOCK_socket_listener_active);

    int ret= 0;
    if (shutdown_thr_handle.handle)
        ret= my_thread_join(&shutdown_thr_handle, NULL);
    shutdown_thr_handle.handle= NULL;
    if (0 != ret)
        sql_print_warning("Could not join shutdown thread. error:%d", ret);

    clean_up(1);
    mysqld_exit(MYSQLD_SUCCESS_EXIT);
}
```
所以，从上面的代码看出，mysqld启动时做了以下功能：
- 处理配置文件及启动参数
- 日志系统初始化
- 初始化很多系统内部变量
- 信号系统初始化
- 核心模块启动，包括存储引擎等
- 终端重定向处理
- 网络系统初始化
- 状态变量初始化
- Binlog相关检查初始化
- 服务监听线程创建

### 

















