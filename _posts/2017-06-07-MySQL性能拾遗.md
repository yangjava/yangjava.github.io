---
layout: post
categories: [MySQL]
description: none
keywords: MySQL
---
# MySQL性能拾遗
这里先明确一下，什么才是我们关注的性能问题。我们所说的MySQL性能是指用MySQL存储和查询数据的效率。这可以用TPC-C等测试模型进行测试，用TPS或QPS来量化。作为MySQL的使用者，我们当然是期望MySQL提供尽可能大的TPS或QPS，通俗地说，就是期望MySQL的性能尽量好，执行SQL语句尽量快。

影响MySQL性能的因素很多，拟从以下几个方面谈起。

## 适当的数据文件大小
不管是什么数据库，数据量大了之后，都会影响数据库的性能，这是很容易理解的。毕竟，操作数据最终会归结到物理的扫描，数据量越来越大，数据文件的大小也会不断增长，索引文件也越来越大，在对B+树搜索时，可能会因为其层数不同，对性能有所影响。更为严重的是，如果SQL语句没有用到索引或索引不够优化，需要扫描数据文件的时候，性能就会随着文件大小的增长而急剧下降。

另外，数据文件大到一定程度之后，在DBA进行DDL，或者备份、迁移等日常运维工作的时候，会有很大麻烦，不仅延长了运维时间，还有可能造成不可预期的风险。所以，在很多数据库的使用规范里面都有一条，即限制数据库单表的数据量和数据文件大小。

## 碎片空洞问题
关于数据库数据量大了之后怎么分库分表的问题，不在此讨论。这里要重点说的是另一个容易忽略的问题，即数据文件空洞的问题，主要关注InnoDB引擎。InnoDB在执行数据的修改操作，例如删除一行数据时，表面上看到的是数据库返回删除成功，但在底层并非如此。实际上，这行数据在物理上只是被“标记”为删除，并不从索引和数据文件中真实删除，所以，它所占据的空间也没有真正释放。InnoDB后台有个Purge read，会定期去清理这些已经删除的索引和文件。即便如此，InnoDB也不会回收这些已经删除的空间给操作系统，这就会在数据文件中存在很多空洞，这些空洞很可能会一直存在，并且越来越大。

曾经碰到过一个案例，有个表叫news_deliver。它的作用是用来暂存需要分发的消息，等消息过时之后，就会被自动清空。所以，这个表会有大量的插入和删除操作，但它实际的数据量不会太大。但经过了一段时间之后，发现这个表的数据文件越来越大，访问的效率也急剧下降。通过SHOW TABLE STATUS发现这个表的碎片或空洞非常严重，判断的办法是通过SHOWTABLE STATUS的结果，查看实际数据Data_length和空洞数据Data_free的比例。如果Data_free非常大，则说明这个表需要优化了，优化的方法是：用OPTIMIZE TABLE<table>或ALTER TABLE<table>ENGINE=InnoDB来重建表空间。

为了及时发现并修复碎片空洞问题，在内部的巡检平台上特意加上了碎片巡检这一项，其原理就是根据上面提到的Data_length和Data_free的数值来判断的，强烈建议MySQL的使用者在平时的生产过程中都要关注这个问题。

## 设计问题
除了上面所说的，要注意碎片空洞问题外，在设计和维护数据库表的时候，平时注意一些细微问题，也有助于尽可能地控制数据库数据文件的大小。
- 字段的合理设置。
在设计表的时候，要合理地选择正确的字段类型，根据需要而定，不能过度滥用，有个原则是：尽可能使用最小的数据类型，最小的也是最有效的。例如，所有的数字都用Bigint，所有的字符串都是varchar（1024）或直接用Text等，这都是不对的。仅仅是数字类型，MEDIUM INT就比INT节省四分之一的空间。有个著名的特例，就是IP类型的存储，惯例上会用字符串存储点分十进制数据，而IP本质上却是一个无符号的整型数字，这就只会用到原来需要空间的四分之一了。

还有需要注意的是NULL的默认。有个规则是，在设计表的时候，尽可能地设置字段为NOTNULL。这样在检索数据的时候，不需要再额外逐个值去判断是否为NULL，从而会更好地利用索引，加速SQL的执行速度。同时，每个字段会节省1bit空间。
- 行存储格式。在MySQL 5.7.9之后，InnoDB表的行格式由之前默认的COMPACT变成了DYNAM IC，关于此二者及其他格式的区别，可以查看MySQL在线文档。这里要说的是，总体上，COMPACT格式会节约20%的空间，同时，在存储UTF8或UTF8MB4数据的时候，COMPACT格式在存储时会尽量地节约空间，不对其中的空格进行存储。这与其他存储固定长度数据的类型相比，也会节约不少空间。所以，在一些关键字段的格式选择上，如果有空间问题，可以特殊对待，而不要一味地使用默认值。当然，InnoDB还有一种存储格式为COMPRESSED，相比MyISAM，InnoDB的压缩格式可以同时支持读和写，使用上更方便一些。
- 索引问题。下面还会详细谈到MySQL索引的优化，这里要说的是，添加索引的时候一定要注意它带来的副作用。索引虽然能提升查询的性能，但由于需要额外写索引文件，它会降低MySQL写数据的速度，同时，也会增大数据文件的大小。加的索引越多，写入数据越慢，数据文件越大。所以在设计索引的时候，会要求主键的字段类型一定要用数字类型，并且要尽可能地小，能用INT的，绝对不要用BIGINT。在设计二级索引的时候，只添加最需要的索引，避免添加重复索引和冗余索引，针对长字符串字段，尽量添加前缀索引。






























































































































































































