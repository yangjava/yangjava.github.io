---
layout: post
categories: Docker
description: none
keywords: Docker
---

## 容器网络

### Docker 网络模式

① bridge：**--net=bridge**

默认网络，docker 启动后会创建一个 docker0 网桥，默认创建的容器会添加到这个网桥中。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191006221018676-1826142752.png)

创建容器时不指定网络模式，默认使用 bridge 方式，通过容器网络配置可以看到会默认分配一个 docker0 的内网IP。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191006221712371-558945729.png)

② host：**--net=host**

容器不会获得一个独立的 network namespace，而是与主机共用一个。这就意味着容器不会有自己的网卡信息，而是使用宿主机的。容器除了网络，其它都是隔离的。

可以看到 host 网络模式下，容器网络配置与宿主机是一样的。那么容器内应用的端口将占用宿主机的端口。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191006222034377-323969518.png)

③ none：**--net=none**

获取独立的 network namespace，但不为容器进行任何网络配置，需要我们手动配置。应用场景比较少。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191006222522643-1364582786.png)

④ container：**--net=container:<CONTAINER NAME/ID>**

与指定的容器使用同一个 network namespace，具有同样的网络配置信息，两个容器除了网络，其它都是隔离的。

\1) 创建容器，并映射 9090 端口到容器的 80 端口，进入容器内，通过 netstat -antp 可以看到没有端口连接信息

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191006223802000-1773597709.png)

\2) 创建 nginx 容器，并使用 net_container 容器的网络。可以看到 net_container 容器内已经在监听 nginx 的80端口了，而且通过 映射的 9090 端口可以访问到 nginx 服务。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191006224235577-1982026757.png)

⑤ 自定义网络

与默认的bridge原理一样，但自定义网络具备内部DNS发现，可以通过容器名或者主机名进行容器之间网络通信

首先创建一个自定义网络，创建两个容器并加入到自定义网络，在容器中就可以互相连通。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191007123036413-300458064.png)



### 容器网络访问原理

当 Docker 启动时，会自动在主机上创建一个 docker0 虚拟网桥（其上有一个 docker0 内部接口），实际上是Linux 的一个 bridge，可以理解为一个软件交换机。它在内核层连通了其他的物理或虚拟网卡，这就将所有容器和本地主机都放到同一个物理网络。

每次创建一个新容器的时候，Docker 从可用的地址段中选择一个空闲的 IP 地址分配给容器的 eth0 端口。使用本地主机上 docker0 接口的 IP 作为所有容器的默认网关。

当创建一个 Docker 容器的时候，同时会创建一对 veth pair 接口（当数据包发送到一个接口时，另外一个接口也可以收到相同的数据包）。这对接口一端在容器内，即 eth0 ；另一端在本地并被挂载到 docker0 网桥，名称以 veth 开头。通过这种方式，主机可以跟容器通信，容器之间也可以相互通信。Docker 就创建了在主机和所有容器之间的一个虚拟共享网络。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191007124456783-38819526.png)

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191007125216709-1729870172.png)

