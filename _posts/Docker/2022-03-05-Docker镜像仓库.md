---
layout: post
categories: Docker
description: none
keywords: Docker
---
# 镜像仓库
仲夏苦夜短,开轩纳微凉。  ——杜甫《夏夜叹》

Docker 仓库用来保存镜像，可以理解为代码控制中的代码仓库。同样的，Docker 仓库也有公有和私有的概念。公有的 Docker 仓库名字是 Docker Hub。Docker Hub 提供了庞大的镜像集合供使用。这些镜像可以是自己创建，或者在别人的镜像基础上创建。Docker 仓库是 Docker 的分发部分。

## Habor

镜像仓库是集中存放镜像的地方。目前 Docker 官方维护了一个公共仓库 Docker Hub，大部分需求，都可以通过在 Docker Hub 中直接下载镜像来实现。

有时候使用 Docker Hub 这样的公共仓库可能不方便，用户可以创建一个本地仓库供私人使用。docker-registry 是官方提供的工具，可以用于构建私有的镜像仓库。

Habor 是由 VMWare 公司开源的容器镜像仓库，Habor 在 docker-registry 上进行了相应的企业级扩展，从而获得了更加广泛的应用。这章学习如何使用 Habor 搭建本地私有仓库。

Harbor 安装及配置要求参考：[Installation and Configuration Guide](https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md)

Harbor 使用文档参考：[User Guide](https://github.com/goharbor/harbor/blob/master/docs/user_guide.md)

安装 Harbor 前，需确保硬件条件至少 2核4G内存40G的硬盘，本机需已安装 docker、docker-compose、openssl。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020175857146-278088255.png)

## 安装 Docker Compose

Docker Compose 是 Docker 官方编排（Orchestration）项目之一，负责快速在集群中部署分布式应用。使用 Docker Compose 可以轻松、高效的管理容器，它是一个用于定义和运行多容器 Docker 的应用程序工具。它允许用户通过一个单独的 docker-compose.yml 模板文件来定义一组相关联的应用容器为一个项目。Harbor 也是基于 docker compose 编排部署的。

① 安装 Docker Compose 可以通过下面命令自动下载适应版本的 Compose，并为安装脚本添加执行权限

```
# curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
# chmod +x /usr/local/bin/docker-compose
```

② 检测安装是否成功

```
# docker-compose -v
```

### 安装 Harbor

① 首先从 github 下载二进制包，选择一个最新版本安装：https://github.com/goharbor/harbor/releases

```
# wget https://storage.googleapis.com/harbor-releases/release-1.9.0/harbor-offline-installer-v1.9.1.tgz
```

② 解压

```
# tar zxvf harbor-offline-installer-v1.9.1.tgz
# cd harbor
```

③ 修改配置文件

```
# vim harbor.yml
```

主要修改 hostname 为可访问的域名或IP、修改管理员密码

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020201918076-1520108744.png)

④ 安装

```
# ./prepare
# ./install.sh
```

Harbor 安装成功后，实际上就是通过 docker compose 启动了相关组件的容器

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020202737427-1592916381.png)

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020205806054-458219658.png)

⑤ Harbor 生命周期管理

harbor 基于 docker compose 编排部署，因此可以使用 docker-compose 命令来管理 harbor 的生命周期。

首先切到 harbor 根目录下

停止 harbor：**docker-compose stop**

重启 harbor：**docker-compose start**

修改配置：

```
# #先停止 harbor
# docker-compose down -v
# #修改 harbor.yml
# vim harbor.yml
# #运行 prepare 填充配置
# ./prepare
# #启动harbor
# docker-compose up -d
```

### Harbor 简单使用

① 访问 Harbor

访问配置的 hostname 进入 harbor 管理页面。具体如何使用可参考官方文档：[User Guide](https://github.com/goharbor/harbor/blob/master/docs/user_guide.md)

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020204507210-1425348155.png)

通过新建项目创建一个项目(bojiangzhou)用于测试。公开项目不需登录就可以下载镜像，私有的需要登录；上传镜像则都需要登录才能上传镜像。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020213418601-800905329.png)

推送镜像的命令格式可以参考如下：

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020213524755-1880208073.png)

② 创建用户

若想上传镜像，需要用户登录，首先在用户管理创建用户：

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020213930603-2047571943.png)

接着在项目中添加用户成员：

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020214048824-640916042.png)

③ 前置配置

上传镜像之前，首先需要将 harbor 仓库配置为 docker 授信的仓库，否则将被拒绝连接：

```
vim /etc/docker/daemon.json
# 配置如下内容
{
    "registry-mirrors": ["http://f1361db2.m.daocloud.io"],
    "insecure-registries": ["192.168.31.54"]
}
```

之后重启 docker 和 harbor：

```
#systemctl restart docker

# cd /docker-test/harbor
# docker-compose up -d
```

④ 镜像仓库登录退出

登录：**docker login registry**

退出：**docker logout \**registry\****

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020214333689-1399842223.png)

⑤ 上传镜像

首先需要给镜像打 Tag：**docker tag SOURCE_IMAGE[:TAG] 192.168.31.54/bojiangzhou/IMAGE[:TAG]**

接着推送镜像：**docker push 192.168.31.54/bojiangzhou/IMAGE[:TAG]**

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020214817968-1820509767.png)

可以看到镜像已经推送到镜像仓库了：

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191020214912044-215991698.png)

下载仓库镜像：**docker pull 192.168.31.54/bojiangzhou/nginx-app:1.0.0**