---
layout: post
categories: Docker
description: none
keywords: Docker
---
# Docker容器
明月不谙离恨苦,斜光到晓穿朱户。  ——晏殊《鹊踏枝》

Docker 容器和文件夹很类似，一个Docker容器包含了所有的某个应用运行所需要的环境。每一个 Docker 容器都是从 Docker 镜像创建的。Docker 容器可以运行、开始、停止、移动和删除。每一个 Docker 容器都是独立和安全的应用平台，Docker 容器是 Docker 的运行部分。

## 容器管理

### 创建容器

启动容器有两种方式，一种是基于镜像新建一个容器并启动，另外一个是将在终止状态（stopped）的容器重新启动。Docker 容器非常轻量级，很多时候可以随时删除和新创建容器。

创建容器的主要命令为 **docker run (或 docker container run)**，常用参数如下：

```
[root@localhost usr]# docker run --help

Usage:  docker run [OPTIONS] IMAGE [COMMAND] [ARG...]

Run a command in a new container

Options:
      --add-host list                  Add a custom host-to-IP mapping (host:ip)
  -a, --attach list                    Attach to STDIN, STDOUT or STDERR
      --blkio-weight uint16            Block IO (relative weight), between 10 and 1000, or 0 to disable (default 0)
      --blkio-weight-device list       Block IO weight (relative device weight) (default [])
      --cap-add list                   Add Linux capabilities
      --cap-drop list                  Drop Linux capabilities
      --cgroup-parent string           Optional parent cgroup for the container
      --cgroupns string                Cgroup namespace to use (host|private)
                                       'host':    Run the container in the Docker host's cgroup namespace
                                       'private': Run the container in its own private cgroup namespace
                                       '':        Use the cgroup namespace as configured by the
                                                  default-cgroupns-mode option on the daemon (default)
      --cidfile string                 Write the container ID to the file
      --cpu-period int                 Limit CPU CFS (Completely Fair Scheduler) period
      --cpu-quota int                  Limit CPU CFS (Completely Fair Scheduler) quota
      --cpu-rt-period int              Limit CPU real-time period in microseconds
      --cpu-rt-runtime int             Limit CPU real-time runtime in microseconds
  -c, --cpu-shares int                 CPU shares (relative weight)
      --cpus decimal                   Number of CPUs
      --cpuset-cpus string             CPUs in which to allow execution (0-3, 0,1)
      --cpuset-mems string             MEMs in which to allow execution (0-3, 0,1)
  -d, --detach                         Run container in background and print container ID
      --detach-keys string             Override the key sequence for detaching a container
      --device list                    Add a host device to the container
      --device-cgroup-rule list        Add a rule to the cgroup allowed devices list
      --device-read-bps list           Limit read rate (bytes per second) from a device (default [])
      --device-read-iops list          Limit read rate (IO per second) from a device (default [])
      --device-write-bps list          Limit write rate (bytes per second) to a device (default [])
      --device-write-iops list         Limit write rate (IO per second) to a device (default [])
      --disable-content-trust          Skip image verification (default true)
      --dns list                       Set custom DNS servers
      --dns-option list                Set DNS options
      --dns-search list                Set custom DNS search domains
      --domainname string              Container NIS domain name
      --entrypoint string              Overwrite the default ENTRYPOINT of the image
  -e, --env list                       Set environment variables
      --env-file list                  Read in a file of environment variables
      --expose list                    Expose a port or a range of ports
      --gpus gpu-request               GPU devices to add to the container ('all' to pass all GPUs)
      --group-add list                 Add additional groups to join
      --health-cmd string              Command to run to check health
      --health-interval duration       Time between running the check (ms|s|m|h) (default 0s)
      --health-retries int             Consecutive failures needed to report unhealthy
      --health-start-period duration   Start period for the container to initialize before starting health-retries countdown (ms|s|m|h) (default 0s)
      --health-timeout duration        Maximum time to allow one check to run (ms|s|m|h) (default 0s)
      --help                           Print usage
  -h, --hostname string                Container host name
      --init                           Run an init inside the container that forwards signals and reaps processes
  -i, --interactive                    Keep STDIN open even if not attached
      --ip string                      IPv4 address (e.g., 172.30.100.104)
      --ip6 string                     IPv6 address (e.g., 2001:db8::33)
      --ipc string                     IPC mode to use
      --isolation string               Container isolation technology
      --kernel-memory bytes            Kernel memory limit
  -l, --label list                     Set meta data on a container
      --label-file list                Read in a line delimited file of labels
      --link list                      Add link to another container
      --link-local-ip list             Container IPv4/IPv6 link-local addresses
      --log-driver string              Logging driver for the container
      --log-opt list                   Log driver options
      --mac-address string             Container MAC address (e.g., 92:d0:c6:0a:29:33)
  -m, --memory bytes                   Memory limit
      --memory-reservation bytes       Memory soft limit
      --memory-swap bytes              Swap limit equal to memory plus swap: '-1' to enable unlimited swap
      --memory-swappiness int          Tune container memory swappiness (0 to 100) (default -1)
      --mount mount                    Attach a filesystem mount to the container
      --name string                    Assign a name to the container
      --network network                Connect a container to a network
      --network-alias list             Add network-scoped alias for the container
      --no-healthcheck                 Disable any container-specified HEALTHCHECK
      --oom-kill-disable               Disable OOM Killer
      --oom-score-adj int              Tune host's OOM preferences (-1000 to 1000)
      --pid string                     PID namespace to use
      --pids-limit int                 Tune container pids limit (set -1 for unlimited)
      --platform string                Set platform if server is multi-platform capable
      --privileged                     Give extended privileges to this container
  -p, --publish list                   Publish a container's port(s) to the host
  -P, --publish-all                    Publish all exposed ports to random ports
      --pull string                    Pull image before running ("always"|"missing"|"never") (default "missing")
      --read-only                      Mount the container's root filesystem as read only
      --restart string                 Restart policy to apply when a container exits (default "no")
      --rm                             Automatically remove the container when it exits
      --runtime string                 Runtime to use for this container
      --security-opt list              Security Options
      --shm-size bytes                 Size of /dev/shm
      --sig-proxy                      Proxy received signals to the process (default true)
      --stop-signal string             Signal to stop a container (default "SIGTERM")
      --stop-timeout int               Timeout (in seconds) to stop a container
      --storage-opt list               Storage driver options for the container
      --sysctl map                     Sysctl options (default map[])
      --tmpfs list                     Mount a tmpfs directory
  -t, --tty                            Allocate a pseudo-TTY
      --ulimit ulimit                  Ulimit options (default [])
  -u, --user string                    Username or UID (format: <name|uid>[:<group|gid>])
      --userns string                  User namespace to use
      --uts string                     UTS namespace to use
  -v, --volume list                    Bind mount a volume
      --volume-driver string           Optional volume driver for the container
      --volumes-from list              Mount volumes from the specified container(s)
  -w, --workdir string                 Working directory inside the container

```

![img](https://img2018.cnblogs.com/blog/856154/201909/856154-20190923230033784-1475011422.png)

当利用 docker run 来创建容器时，Docker 在后台运行的标准操作包括：

- 检查本地是否存在指定的镜像，不存在就从公有仓库下载
- 利用镜像创建并启动一个容器
- 分配一个文件系统，并在只读的镜像层外面挂载一层可读写层
- 从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去
- 从地址池配置一个 ip 地址给容器
- 执行用户指定的应用程序
- 执行完毕后容器被终止

① 创建并进入容器：**docker run -ti <IMAGE ID OR NAME> /bin/bash**

创建容器，通过 **-ti** 参数分配一个 bash 终端，并进入容器内执行命令。退出容器时容器就被终止了。

```
[root@localhost usr]# docker run -ti mysql /bin/bash
root@1f4533013531:/# ls
bin  boot  dev	docker-entrypoint-initdb.d  entrypoint.sh  etc	home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
root@1f4533013531:/# exit
exit
[root@localhost usr]# docker ps -a
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                      PORTS     NAMES
1f4533013531   mysql     "docker-entrypoint.s…"   43 seconds ago   Exited (0) 18 seconds ago             epic_lichterman


```

② 容器后台运行：**docker run -d <IMAGE ID OR NAME>**

```
[root@localhost usr]# docker run -d mysql
2f40507d0192409e7b0f0fe15b7862938c8814103c611740abe35c5f36b5f608
[root@localhost usr]# docker ps -a
CONTAINER ID   IMAGE     COMMAND                  CREATED              STATUS                      PORTS     NAMES
2f40507d0192   mysql     "docker-entrypoint.s…"   9 seconds ago        Exited (1) 8 seconds ago              blissful_sinoussi
1f4533013531   mysql     "docker-entrypoint.s…"   About a minute ago   Exited (0) 54 seconds ago             epic_lichterman

```

容器是否会长久运行，是和 docker run 指定的命令有关，即容器内是否有前台进程在运行，和 -d 参数无关。一个容器必须有一个进程来守护容器才会在后台长久运行。

例如通过 -d 参数后台运行 centos，容器创建完成后将退出。而通过 -ti 分配一个伪终端后，容器内将有一个 bash 终端守护容器，容器不会退出。

![img](https://img2018.cnblogs.com/blog/856154/201909/856154-20190923233721960-1995535823.png)

③ 进入容器：**docker exec -ti <CONTAINER ID> bash**

![img](https://img2018.cnblogs.com/blog/856154/201909/856154-20190923234704353-500720325.png)

④ 指定端口：**docker run -d -p <宿主机端口>:<容器内端口> <IMAGE ID>**

通过 -p 参数指定宿主机与容器内的端口映射，如果不指定宿主机端口，将会随机映射一个宿主机端口。映射好端口后，宿主机外部就可以通过该端口访问容器了。

![img](https://img2018.cnblogs.com/blog/856154/201909/856154-20190923235027844-222049269.png)

⑤ 宿主机重启时自动重启容器：**docker run -d --restart always <IMAGE ID>**

宿主机重启时，docker 容器默认不会自动启动，可以通过 --restart=always 设置自动重启。

### 容器资源限制

容器资源限制主要是对内存的限制和使用CPU数量的限制，常用选项如下：

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191002145017354-1453708331.png)

① 使用例子

1) 限制容器最多使用500M内存和100M的Swap，并禁用OOM Killer。注意 --memory-swap 的值为 --memory 的值加上 Swap 的值。

docker run -d --name nginx_1 --memory="500m" --memory-swap="600m" --oom-kill-disable nginx

如果 memory 小于等于 memory-swap，表示不使用Swap；如果 memory-swap="-1" 表示可以无限使用Swap；如果不设置 memory-swap，其值默认为 memory 的2倍。

2) 允许容器最多使用一个半的CPU：docker run -d --name nginx_2 --cpus="1.5" nginx

3) 允许容器最多使用 50% 的CPU：docker run -d --name nginx_3 --cpus=".5" nginx

② 查看容器资源使用统计：**docker stats <CONTAINER ID>**

通过 docker stats 可以实时查看容器资源使用情况。如果不对容器内存或CPU加以限制，将默认使用物理机所有内存和CPU。通常情况下，为了安全一定要限制容器内存和CPU，否则容器内程序遭到攻击，可能无限占用物理机的内存和CPU。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191002153256322-386222621.png)



## 容器常用命令

① 停止容器：**docker stop <CONTAINER ID>**

② 重启容器：**docker start \**<CONTAINER ID>\****

③ 删除容器

删除已停止的容器：**docker rm <CONTAINER ID>**

强制删除运行中的容器：**docker rm -f <CONTAINER ID>**

批量删除Exited(0)状态的容器：**docker rm $(docker ps -aq -f exited=0)**

批量删除所有容器：**docker rm -f $(docker ps -aq)**

④ 查看容器日志：**docker logs <CONTAINER ID OR NAMES>**

![img](https://img2018.cnblogs.com/blog/856154/201909/856154-20190923235530512-618197819.png)

⑤ 查看容器详细信息：**docker inspect <CONTAINER ID>**

⑥ 列出或指定容器端口映射：**docker port <CONTAINER ID>**

⑦ 显示一个容器运行的进程：**docker top <CONTAINER ID>**

⑧ 拷贝文件/文件夹到容器：**docker cp <dir> <CONTAINER ID>:<dir>**

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191002161821752-1503549770.png)

⑨ 查看容器与镜像的差异：**docker diff <CONTAINER ID>**

![img](https://img2018.cnblogs.com/blog/856154/201909/856154-20190923224554682-2090054521.png)