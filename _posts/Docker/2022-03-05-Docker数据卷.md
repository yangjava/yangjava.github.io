---
layout: post
categories: Docker
description: none
keywords: Docker
---

## 数据卷

### 简介

需求:

- Docker 可以将运行的环境打包形成容器运行，但是我们对 Docker 容器的数据的要求希望是持久化的
- 容器之间希望共享数据

Docker容器产生的数据，如果不通过docker commit生成新的镜像，使得数据做为镜像的一部分保存下来， 那么当容器删除后，数据自然也就没有了。

为了能保存数据在docker中我们使用数据卷。

类似 Redis里面的rdb和aof文件或者我们平时使用的移动硬盘

容器删除后，里面的数据将一同被删除，因此需要将容器内经常变动的数据存储在容器之外，这样删除容器之后数据依然存在。

### 数据卷的用处

数据卷就是目录或文件，存在于一个或多个容器中，由docker挂载到容器，但不属于联合文件系统，因此能够绕过Union File System提供一些用于持续存储或共享数据的特性：

数据卷的设计目的就是数据的持久化，完全独立于容器的生存周期，因此Docker不会在容器删除时删除其挂载的数据卷

特点：

1. 数据卷可在容器之间共享或重用数据
2. 卷中的更改可以直接生效
3. 数据卷中的更改不会包含在镜像的更新中
4. 数据卷的生命周期一直持续到没有容器使用它为止

Docker 提供三种方式将数据从宿主机挂载到容器中：

- **volumes**：由 Docker 管理的数据卷，是宿主机文件系统的一部分(/var/lib/docker/volumes)。是保存数据的最佳方式。
- **bind mounts**：将宿主机上的文件或目录挂载到容器中，通常在容器需要使用宿主机上的目录或文件时使用，比如搜集宿主机的信息、挂载宿主机上的 maven 仓库等。
- **tmpfs**：挂载存储在主机系统的内存中，而不会写入主机的文件系统。如果不希望将数据持久存储在任何位置，可以使用 tmpfs，同时避免写入容器可写层提高性能。这种方式使用比较少。



### Volume

① 管理卷

创建数据卷：**docker volume create <volume_name>**

查看数据卷列表：**docker volume ls**

查看数据卷详细信息：**docker volume inspect <volume_name>**

创建的数据卷默认在宿主机的 /var/lib/docker/volumes/ 下

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191006175104915-175131327.png)

② 创建容器时指定数据卷

\1) 通过 --mount 方式：**--mount src=<数据卷名称>,dst=<容器内的数据目录>，注意逗号之间不能有空格**

docker run -d --name nginx_1 --mount src=nginx_html,dst=/usr/share/nginx/html nginx

\2) 通过 -v 方式：**-v <数据卷名称>:<容器内的数据目录>**

docker run -d --name nginx_2 -v nginx_html:/usr/share/nginx/html nginx

以上两种方式，--mount 更加通用直观，-v 是老语法的方式。如果对应的数据卷不存在，将自动创建数据卷。如果挂载目标在容器中非空，则该目录现有内容会自动同步到数据卷中。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191006175210780-649821198.png)

③ 删除数据卷：**docker volume rm <volume_name>**

数据卷是独立于容器的生命周期的，删除容器是不会删除数据卷的，除非删除数据卷，删除数据卷之后数据也就丢失了。

如果数据卷正在被某个容器使用，将不能被删除，需要先删除使用此数据卷的所有容器之后才能删除数据卷。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191006173817305-2022720420.png)

④ Volume 特点及使用场景

- 多个容器可以同时挂载相同的卷，可用于多个运行容器之间共享数据。
- 当容器停止或被删除后，数据卷依然存在。当明确删除卷时，卷才会被删除。
- 可以将容器的数据存储在远程主机或其它存储上。
- 将数据从一台 docker 主机迁移到另一台主机时，先停止容器，然后备份卷的目录 /var/lib/docker/volumes



### Bind Mounts

① 创建容器时绑定数据卷

\1) 通过 --mount 方式：**--mount type=bind,src=<宿主机目录>,dst=<容器内的数据目录>，注意逗号之间不能有空格**

docker run -d --name nginx_1 --mount type=bind,src=/data/nginx/html,dst=/usr/share/nginx/html nginx

\2) 通过 -v 方式：**-v <宿主机目录>:\**<容器内的数据目录>\****

docker run -d --name nginx_2 -v /data/nginx/html:/usr/share/nginx/html nginx

以上两种方式，如果源文件/目录不存在，不会自动创建容器，会抛出错误。与 volume 方式相比，如果挂载目标在容器中非空，则该目录现有内容将被隐藏，可以理解成使用宿主机的目录覆盖了容器中的目录，新增的数据会同步。

![img](https://img2018.cnblogs.com/blog/856154/201910/856154-20191006174708341-358044453.png)

② Bind Mounts 特点及使用场景

- 从主机共享配置文件到容器。默认情况下，挂载主机 /etc/resolv.conf 到每个容器，提供 DNS 解析。
- 在 docker 主机上的开发环境和容器之间共享源代码。例如，可以将 maven target 目录挂载到容器中，每次在 docker 主机上构建maven项目时，容器都可以访问构建好的项目包。
- 当 docker 主机的文件或目
- 录结构保证与容器所需的绑定挂载一致时，例如容器中需要统计主机的一些信息，可以直接将主机的某些目录直接挂载给容器使用。