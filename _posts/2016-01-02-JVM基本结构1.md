---
layout: post
categories: [JVM]
description: none
keywords: JVM
---
# JVM基本结构
Java虚拟机那么复杂，它的基本结构是什么?各个组成部分有何作用?又是如何相互协调工作的呢?
本文主要讨论Java虚拟机架构、Java堆、Java栈、永久区和元数据区的基本概念以及完整的说明。

本章涉及的主要知识点有：
- Java虚拟机架构
- JVM 内存区域概览
- 程序计数器
- 认识Java虚拟机中的堆。堆区的空间分配是怎么样？
- 创建一个新对象内存是怎么分配的？
- 了解有关栈的概念和使用。栈帧是什么？栈帧里有什么？怎么理解？本地方法栈
- 了解存放类型描述的永久区和元数据区。方法区 到 Metaspace 元空间
- Code Cache 是什么？

## Java虚拟机架构
JVM包含堆、元空间、Java虚拟机栈、本地方法栈、程序计数器等内存区域，其中堆是占用内存最大的，如下图所示：
```text
              
           [Java Class文件]   ------》   [Class Loader] 
                                             
           .——————————————————————————————————————————.
           |[方法区]     [虚拟机栈]        [本地方法栈]    | 
           |                                          |
           |[堆] [直接内存]         [程序计数器]          |
           |                                          |
           |  [垃圾回收系统]                             |
           .—————————————————————————————————————————-.
           
           [执行引擎]    [本地库接口]        [本地方法库]           
           
```
参考官网地址[https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html](https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html)
![Java虚拟机架构](https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/images/gcslides/Slide1.png)
Java虚拟机在执行Java程序的过程中会把它所管理的内存划分为若干个不同的数据区域。这些区域都有各自的用途，以及创建和销毁的时间，有的区域随着虚拟机进程的启动而存在，有些区域则依赖用户线程的启动和结束而建立和销毁。根据《Java虚拟机规范（Java SE 7版）》的规定，Java虚拟机所管理的内存将会包括以下几个运行时数据区域。在 Java 中，JVM 内存模型主要分为堆、方法区、程序计数器、虚拟机栈和本地方法栈。其中，堆和方法区被所有线程共享，虚拟机栈、本地方法栈、程序计数器是线程私有的。
Java虚拟机的基本结构：
- **类加载子系统**
  负责从文件系统或者网络中加载Class信息，加载的类信息存放于一块称为方法区的内存空间。除了类信息外，方法区中可能还会存放运行时常量池信息，包括字符串量和数字常量。
- **方法区**
  方法区用于存储类型信息，运行时常量池信息，包括字符串量和数字常量。和堆一样，方法区是一块所有线程共享的内存区域。它用于保存系统的类信息，比如类的字段、方法、常量池等。方法区的大小决定了系统可以保存多少个类，如果系统定义了太多的类，导致方法区溢出，虚拟机同样会抛出内存溢出的错误。
  在JDK1.6、JDK1.7中，方法区可以理解为永久区。永久区可以使用参数-XX:PermSize和-XX:MaxPermSize指定，默认情况下，-XX:MaxPermSize为64M。在JDK1.8中，永久代已经被彻底移除。取而代之的是元数据区，元数据区大小可以使用参数  -XX:MaxMetaspaceSize指定，这是一块堆外的直接内存。与永久区不同，如果不指定大小，默认情况下，虚拟机会耗所有的可用系统内存。
- **Java堆**
  在虚拟机启动的时候建立的，他是Java程序最主要的内存工作区，几乎所有的对象实例都存放在java堆中。堆空间是线程共享的。Java堆是和Java应用程序关系最为密切的内存空间，几乎所有的对象都存放在堆中。并且Java堆是完全自动化管理的，通过垃圾回收机制，垃圾对象会被自动清理，而不需要显示的释放。根据垃圾回收机制的不同，Java堆有可能拥有不同的结构。
- **直接内存**
  直接内存时在Java堆外的、直接向系统申请的内存空间。通常，访问直接内存的速度会优于Java堆。因此处于性能考虑，读写频繁的场合会考虑使用直接内存。由于直接内存在Java堆外，因此它的大小不会直接受限于Xmx指定的最大堆大小，但是系统内存时有限的，Java堆和直接内存的总和依然受限于系统给出的最大内存。
- **垃圾回收系统**
   是java虚拟机的重要组成部分，垃圾回收器会对方法区，java堆和直接内存进行回收。
- **Java栈**
  每一个Java虚拟机线程都有一个私有的Java栈，一个线程的线程栈在线程创建的时候创建，Java栈中保存着帧信息，局部变量，方法参数，同时和Java方法的调用和返回密切相关。
- **本地方法栈**
  用户存储本地方法的调用。作为对虚拟机的重要拓展，Java虚拟机允许Java直接调用本地方法。
- **PC寄存器**
  也是每个线程私有的空间，Java虚拟机会为每个Java线程创建PC寄存器，在任意时刻，一个Java线程总是在执行一个方法，这个正在被执行的方法被称为当前方法，如果当前方法不是本地方法，PC寄存器就会指向当前正在被执行的指令。如果当前方法是本地方法，那么PC寄存器的值就是undefined.
- **执行引擎**
  是Java虚拟机最核心的组件之一，它扶着执行虚拟机的字节码。虚拟机为了提高执行效率，会使用即时编译技术将方法编译成字节码后在执行。
