---
layout: post
categories: [Neo4j]
description: none
keywords: Neo4j
---
# Neo4j企业关系图谱


## 股权穿透

为了避免重复计算已经出现的关系，你可以使用ALL()函数结合relationships()函数来检查路径中是否存在重复的关系。
```
MATCH path = (startNode:Node {node_type:'company'})-[r:INVEST*1..4]->(endNode:Node {node_type:'company'})
WHERE startNode.id = $startNodeId AND ALL(rel in relationships(path) WHERE NOT rel IN relationships(path)[0..-2])
WITH startNode, endNode, path,
REDUCE(init = 1, rel IN relationships(path) | init * rel.stock_proportion) AS multiplication
WITH startNode, endNode, SUM(multiplication) AS totalStockProportion
WHERE totalStockProportion > 0.01
RETURN endNode.id AS companyId, endNode.name AS companyName, endNode.company_status AS companyStatus,
       endNode.credit_code AS creditCode, endNode.province_code AS provinceCode,
       endNode.city_code AS cityCode, endNode.area_code AS areaCode,
       endNode.industry_first_code AS industryFirstCode, totalStockProportion
ORDER BY totalStockProportion DESC
```
用于在Neo4j数据库中查找与起始节点（公司类型的节点）之间具有指定关系类型（INVEST）的路径，并计算路径上所有关系的乘积。然后，根据乘积总和过滤出乘积大于0.01的路径，并返回结束节点的相关属性。

这个查询语句的作用是：

匹配符合条件的路径，起始节点必须为公司类型的节点，关系类型为INVEST，且路径长度在1到4之间。
使用REDUCE函数计算路径上所有关系的stock_proportion属性的乘积。
过滤出乘积总和大于1的路径。
返回结束节点的id、name、company_status、credit_code、province_code、city_code、area_code、industry_first_code和总股比。
根据总股比降序排序返回结果。














