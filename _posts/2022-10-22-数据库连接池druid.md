---
layout: post
categories: [datasource,druid]
description: none
keywords: druid
---
# 数据库连接处druid
Druid是阿里巴巴开源平台上一个数据库连接池实现，结合了 C3P0、DBCP 等 DB 池的优点，同时加入了日志监控。

## Druid简介
Druid 可以很好的监控 DB 池连接和 SQL 的执行情况，天生就是针对监控而生的 DB 连接池。 Spring Boot 2.0 以上默认使用 Hikari 数据源，可以说 Hikari 与 Driud 都是当前 Java Web 上最优秀的数据源，我们来重点介绍 Spring Boot 如何集成 Druid 数据源，如何实现数据库监控。

## 配置数据源
添加上 Druid 数据源依赖
```xml
<!-- https://mvnrepository.com/artifact/com.alibaba/druid -->
<dependency>    
    <groupId>com.alibaba</groupId>   
    <artifactId>druid</artifactId>    
    <version>1.1.21</version>
</dependency>
```
切换数据源；之前已经说过 Spring Boot 2.0 以上默认使用 com.zaxxer.hikari.HikariDataSource 数据源，但可以 通过 spring.datasource.type 指定数据源。
```yaml
spring:
  datasource:
    username: root
    password: 123456
    url: jdbc:mysql://localhost:3306/springboot?serverTimezone=UTC&useUnicode=true&characterEncoding=utf-8
    driver-class-name: com.mysql.cj.jdbc.Driver
    type: com.alibaba.druid.pool.DruidDataSource # 自定义数据源
```
为 DruidDataSource 绑定全局配置文件中的参数，再添加到容器中，而不再使用 Spring Boot 的自动生成了；我们需要 自己添加 DruidDataSource 组件到容器中，并绑定属性；
```java

import com.alibaba.druid.pool.DruidDataSource;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.sql.DataSource;

@Configuration
public class DruidConfig {

    /*
       将自定义的 Druid数据源添加到容器中，不再让 Spring Boot 自动创建
       绑定全局配置文件中的 druid 数据源属性到 com.alibaba.druid.pool.DruidDataSource从而让它们生效
       @ConfigurationProperties(prefix = "spring.datasource")：作用就是将 全局配置文件中
       前缀为 spring.datasource的属性值注入到 com.alibaba.druid.pool.DruidDataSource 的同名参数中
     */
    @ConfigurationProperties(prefix = "spring.datasource")
    @Bean
    public DataSource druidDataSource() {
        return new DruidDataSource();
    }

}
```

## 配置Druid数据源监控
Druid 数据源具有监控的功能，并提供了一个 web 界面方便用户查看，类似安装 路由器 时，人家也提供了一个默认的 web 页面。
所以第一步需要设置 Druid 的后台管理页面，比如 登录账号、密码 等；配置后台管理；
```java
//配置 Druid 监控管理后台的Servlet；
//内置 Servlet 容器时没有web.xml文件，所以使用 Spring Boot 的注册 Servlet 方式@Beanpublic 
ServletRegistrationBean statViewServlet() {   
    ServletRegistrationBean bean = new ServletRegistrationBean(new StatViewServlet(), "/druid/*");
    // 这些参数可以在 com.alibaba.druid.support.http.StatViewServlet     
    // 的父类 com.alibaba.druid.support.http.ResourceServlet 中找到    
    Map<String, String> initParams = new HashMap<>();    
    initParams.put("loginUsername", "admin"); 
    //后台管理界面的登录账号    
    initParams.put("loginPassword", "123456"); 
    //后台管理界面的登录密码
    //后台允许谁可以访问    
    //initParams.put("allow", "localhost")：表示只有本机可以访问    
    //initParams.put("allow", "")：为空或者为null时，表示允许所有访问    
    initParams.put("allow", "");    
    //deny：Druid 后台拒绝谁访问    
    //initParams.put("kuangshen", "192.168.1.20");表示禁止此ip访问
    //设置初始化参数    
    bean.setInitParameters(initParams);    
    return bean;
}
```
配置完毕后，我们可以选择访问 ：http://localhost:8080/druid/login.html
## 配置 Druid web 监控 filter 过滤器
```java
//配置 Druid 监控 之  web 监控的 filter
//WebStatFilter：用于配置Web和Druid数据源之间的管理关联监控统计
@Beanpublic FilterRegistrationBean webStatFilter() {    
    FilterRegistrationBean bean = new FilterRegistrationBean();    
    bean.setFilter(new WebStatFilter());
    //exclusions：设置哪些请求进行过滤排除掉，从而不进行统计    
    Map<String, String> initParams = new HashMap<>();    
    initParams.put("exclusions", "*.js,*.css,/druid/*,/jdbc/*");    
    bean.setInitParameters(initParams);
    //"/*" 表示过滤所有请求    
    bean.setUrlPatterns(Arrays.asList("/*"));    
    return bean;
}
```

## 数据库连接处测试
```java
@SpringBootTest
class SpringbootDataJdbcApplicationTests {

    //DI注入数据源
    @Autowired
    DataSource dataSource;

    @Test
    public void contextLoads() throws SQLException {
        //看一下默认数据源
        System.out.println(dataSource.getClass());
        //获得连接
        Connection connection =   dataSource.getConnection();
        System.out.println(connection);

        DruidDataSource druidDataSource = (DruidDataSource) dataSource;
        System.out.println("druidDataSource 数据源最大连接数：" + druidDataSource.getMaxActive());
        System.out.println("druidDataSource 数据源初始化连接数：" + druidDataSource.getInitialSize());

        //关闭连接
        connection.close();
    }
}

```


## 配置文件详解

### 配置druid的参数的n种方式
使用druid，同一个参数，我们可以采用多种方式进行配置，举个例子：maxActive（最大连接池参数）的配置：
- 方式一(系统属性)
系统属性一般在启动参数中设置。通过方式一来配置连接池参数的还是比较少见。
```
-Ddruid.maxActive=8
```
- 方式二(properties)
这是最常见的一种。
```
maxActive=8
```
- 方式三(properties加前缀)
相比第二种方式，这里只是加了.druid前缀。
```
druid.maxActive=8
```
- 方式四(properties的connectionProperties)
connectionProperties可以用于配置多个属性，不同属性使用";"隔开。
```
connectionProperties=druid.maxActive=8
```
方式五(connectProperties)
connectProperties可以在方式一、方式三和方式四中存在，具体配置如下：
```
druid.connectProperties=druid.connectProperties=druid.connectProperties=druid.connectProperties=druid.maxActive=8
```
真的是没完没了，怎么会引入connectProperties这个属性呢？我觉得这是一个十分失败的设计。
同一个参数，我们有时可以采用无数种方式来配置。表面上看这样设计十分人性化，可以适应不同人群的使用习惯，但是，在我看来，这样设计非常不利于配置的统一管理

### 数据库连接参数
注意，这里在url后面拼接了多个参数用于避免乱码、时区报错问题。 补充下，如果不想加入时区的参数，可以在mysql命令窗口执行如下命令：set global time_zone='+8:00'。
```properties
spring.datasource.url=jdbc:mysql://localhost:3306/analysis?useSSL=false&autoReconnect=true&characterEncoding=utf8
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.username=root
spring.datasource.password=root
```

### 连接池数据基本参数
```properties
# druid参数调优（可选）,若配置如下参数则必须手动添加配置类
# 初始化大小，最小，最大
spring.datasource.initialSize=5
spring.datasource.minIdle=5
spring.datasource.maxActive=20
# 配置获取连接等待超时的时间
spring.datasource.maxWait=60000
```

### 连接检查参数
针对连接失效的问题，建议开启空闲连接测试，而不建议开启借出测试（从性能考虑），另外，开启连接测试时，必须配置validationQuery。
```properties
# 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒
spring.datasource.timeBetweenEvictionRunsMillis=60000
# 配置一个连接在池中最小生存的时间，单位是毫秒
spring.datasource.minEvictableIdleTimeMillis=300000
# 测试连接
spring.datasource.testWhileIdle=true
spring.datasource.testOnBorrow=false
spring.datasource.testOnReturn=false
```
### 缓存语句
针对大部分数据库而言，开启缓存语句可以有效提高性能，但是在myslq下建议关闭。






# 参考资料
Github地址：[https://github.com/alibaba/druid/](https://github.com/alibaba/druid/)