---
layout: post
categories: [Grafana]
description: none
keywords: Grafana
---
# Grafana简介
Grafana是一个跨平台的开源的度量分析和可视化工具，可以通过将采集的数据查询然后可视化的展示，并及时通知。

## Grafana介绍
Grafana 是一个监控仪表系统，它是由 Grafana Labs 公司开源的的一个系统监测工具，它可以大大帮助我们简化监控的复杂度，我们只需要提供需要监控的数据，它就可以帮助生成各种可视化仪表，同时它还有报警功能，可以在系统出现问题时发出通知。

Grafana 支持许多不同的数据源，每个数据源都有一个特定的查询编辑器，每个数据源的查询语言和能力都是不同的，我们可以把来自多个数据源的数据组合到一个仪表板，但每一个面板被绑定到一个特定的数据源。

目前官方支持以下数据源：
- Prometheus
- MySQL
- Elasticsearch
- ...

## 特点
- 可视化：快速和灵活的客户端图形具有多种选项。面板插件为许多不同的方式可视化指标和日志。
- 报警：可视化地为最重要的指标定义警报规则。Grafana将持续评估它们，并发送通知。
- 通知：警报更改状态时，它会发出通知。接收电子邮件通知。
- 动态仪表盘：使用模板变量创建动态和可重用的仪表板，这些模板变量作为下拉菜单出现在仪表板顶部。
- 混合数据源：在同一个图中混合不同的数据源!可以根据每个查询指定数据源。这甚至适用于自定义数据源。
- 注释：注释来自不同数据源图表。将鼠标悬停在事件上可以显示完整的事件元数据和标记。
- 过滤器：过滤器允许您动态创建新的键/值过滤器，这些过滤器将自动应用于使用该数据源的所有查询。

## 基本概念
在入门 Grafana 前，需要了解一些基本概念。

### 数据源Data Source
Grafana 展示数据，但不提供数据。因此，需要给它配置数据源，目前Grafana 支持的数据源有：Prometheus, Elasticsearch, MySQL等。

### DashBoard
仪表盘，数据展示的窗口。就像汽车仪表盘一样可以展示很多信息，包括车速，水箱温度等。Grafana的 DashBoard 就是以各种图形的方式来展示从 Datasource 拿到的数据。

### Row
DashBoard 的基本组成单元，一个 DashBoard 可以包含很多个 row 。一个 row 可以展示一种信息或者多种信息的组合，比如系统内存使用率，CPU五分钟及十分钟平均负载等。所以在一个DashBoard上可以集中展示很多内容。

### Panel
面板，实际上就是row展示信息的方式，支持表格（table），列表（alert list），热图（Heatmap）等多种方式。

### Query Editor
Query Editor 顾名思义，就是查询语句管理，类似 sql 语句。每个面板都提供一个Query Editor，我们可以通过编写语句来控制面板展示不同的图表。不同的数据源对应不同的Query Editor：当 Grafana 与 Prometheus 结合使用时，对应的是PromQL。

### 组织Organization
类似于用户组，每个用户可以拥有多个Org，Grafana有一个默认的main org。用户登录后可以在不同的Org之间切换，前提是该用户拥有多个Org。不同的Org之间完全不一样，包括 Datasource，Dashboard 等都不一样。创建一个 Org 就相当于开了一个全新的视图，所有的 Datasource，Dashboard 等都要再重新开始创建。

这里需要注意的是，大多数度量数据库不提供任何类型的每用户系列身份验证。因此，在Grafana中，特定组织中的所有用户都可以使用数据源和仪表盘。

### User
Grafana里面用户有三种角色admin,editor,viewer。admin权限最高，可以执行任何操作，包括创建用户，新增Datasource，创建DashBoard。editor角色不可以创建用户，不可以新增Datasource，可以创建DashBoard。viewer角色仅可以查看DashBoard。

## Grafana工作原理
Grafana 是一个仪表盘，其主要目的是对各种数据提供可视化。 Grafana 本身并不负责数据层，它只提供了通用的接口，让底层的数据库可以把数据给它。

也就是说，Grafana 每次要展现一个仪表盘的时候，会向 数据库 发送一个查询请求。 一般来说，我们需要一个服务来获取我们想要监控或者可视化的数据，然后将其放到Grafana的底层数据库中，等待Grafana展示。然后我们需要配置Grafana表盘，确定需要展示的数据以及形式。

## Grafana的特点
- grafana拥有快速灵活的客户端图表，面板插件有许多不同方式的可视化指标和日志，官方库中具有丰富的仪表盘插件，比如热图、折线图、图表等多种展示方式，让我们复杂的数据展示的美观而优雅。
- Grafana支持许多不同的时间序列数据（数据源）存储后端。每个数据源都有一个特定查询编辑器。每个数据源的查询语言和功能明显不同。你可以将来自多个数据源的数据组合到一个仪表板上，但每个面板都要绑定到属于特定组织的特定数据源。
- Grafana使用来自不同数据源的丰富事件注释图表，将鼠标悬停在事件上会显示完整的事件元数据和标记。

## 安装
Grafana 本身是非常轻量级的，不会占用大量资源，此外 Grafana 需要一个数据库来存储其配置数据，比如用户、数据源和仪表盘等，目前 Grafana 支持 SQLite、MySQL、PostgreSQL 3 种数据库，默认使用的是 SQLite，该数据库文件会存储在 Grafana 的安装位置，所以需要对 Grafana 的安装目录进行持久化。

## 使用

### 创建面板
面板（Panel）是 Grafana 中基本可视化构建块，每个面板都有一个特定于面板中选择数据源的查询编辑器，每个面板都有各种各样的样式和格式选项，面板可以在仪表板上拖放和重新排列，它们也可以调整大小，所以要在 Grafana 上创建可视化的图表，面板是我们必须要掌握的知识点。

### 数据源
在创建面板之前我们需要指定我们的面板数据来源，也就是数据源，Grafana 支持多种数据源，我们这里当然使用 Prometheus 作为数据源来进行说明。

- 在 Grafana 左侧工具栏选择 Configuration，点击到下面的 Data sources，打开添加数据源的页面：
- 点击页面中的 Add data source 按钮开始添加数据源：
- 选择第一项 Prometheus 数据源进行配置：
在 HTTP 项中配置 URL 地址，其实就是 Prometheus 的地址，Access 选择默认的 Server 代理方式，这样就相当于 Grafana 程序去访问 Prometheus 而不是在浏览器端去访问，如果 Prometheus 配置有认证，则还需要在下发配置 Auth 信息，配置完成后，
拉到最下方点击 Save & test，提示添加成功即表面数据源添加成功了。然后在数据源列表中就会出现我们刚刚添加的 Prometheus 这个数据源了：
- 如果想要添加其他支持的数据源则也可用同样的方式进行添加。

### 添加面板
面板是属于某一个 Dashboard 的，所以我们需要先创建一个 Dashboard

- 在侧边栏点击 + 切换到 Dashboard 下面开始创建 Dashboard：
- 在默认创建的新的 Dashboard 中就有一个空的面板，点击 Add an empty panel 即可开始添加面板：
- 进入面板编辑器后即可添加面板了，中间位置是查询语句的显示结果，下方是用于配置查询语句的地方，左侧可以选择面板显示的类型，面板元信息，比如标题、描述信息等。
比如我们现在就要来查询节点的 CPU 使用率，前面在 node_exporter 章节中已经学习了该监控数据的查询语句为 `(1 - sum(rate(node_cpu_seconds_total{mode="idle"}[5m])) by (instance) / sum(rate(node_cpu_seconds_total[5m])) by (instance) ) * 100`，只需要将该语句填充到查询的 PromQL 语句中即可在上面显示出监控的结果：
- 点击右上角的 Apply 按钮即可创建成功一个 Panel 面板。
- 用同样的方式我们可以创建一个用于查询节点内存使用率的面板：
- 创建完成后的面板我们也可以拖动他们的排列位置：
- 如果还想重新编辑面板，可以点击标题，在弹出来的下拉框中选择 Edit 编辑即可：

### 添加参数
现在我们在一个 Dashboard 中添加了两个 Panel，我们可以很明显看到会直接将所有的节点信息展示在同一个面板中，但是如果有非常多的节点的话数据量就非常大了，这种情况下我们最好的方式是将节点当成参数，可以让用户自己去选择要查看哪一个节点的监控信息，要实现这个功能，我们就需要去添加一个以节点为参数的变量来去查询监控数据。

- 点击 Dashboard 页面右上方的 Dashboard settings 按钮，进入配置页面：
- 在该 Settings 页面可以来对整个 Dashboard 进行配置，比如名称、标签、变量等：
这里我们点击左边的 Variables 添加一个变量，变量支持更具交互性和动态性的仪表板，我们可以在它们的位置使用变量，而不是在指标查询中硬编码，变量显示为 Dashboard 顶部的下拉列表，这些下拉列表可以轻松更改仪表板中显示的数据。
- 为了能够选择节点数据，这里我们定义了一个名为 instance 的变量名，但是定义的这个变量值从哪个地方获取呢？
- 监控节点的相关指标是来源于名为 node-exporter 的任务，我们可以通过查询 up 来获取所有的监控实例：
- 要想获取到 instance 标签中的值，我们这里可以使用一个正则表达式 `.*instance="(.*?)".*` 来获取实例数据，这样就成功定义了一个变量，回到 Dashboard 页面就可以看到多了一个选择节点的下拉框：
- 但是这个时候的面板并不会随着我们下拉框的选择而变化，我们需要将 instance 这个变量传入查询语句中，比如重新修改CPU使用率的查询语句：
- 用同样的方式给内存使用率添加根据节点过滤的参数：
- 回到 Dashboard 页面就可以根据我们的下拉框来选择需要监控的节点数据了，定义参数的时候如果选择了可以选择所有，同样可以查看所有节点的数据：

## 与其他系统整合
我们常常需要将grapana的展示图，嵌套到其他系统中，这就需要一个无密码访问的问题。在grafana的配置文件中[auth.anonymous] 这个配置，默认是enabled=false, 修改为true（表示支持匿名登录），然后新启动就可以了。此时不需要登录就可以查看指标图了。

# 参考资料
grafana安装：[http://docs.grafana.org/installation/rpm/](http://docs.grafana.org/installation/rpm/)

官网地址：[https://grafana.com/](https://grafana.com/)

官方文档：[https://grafana.com/grafana/](https://grafana.com/grafana/)

官方参考文档：[https://grafana.com/docs/](https://grafana.com/docs/)
