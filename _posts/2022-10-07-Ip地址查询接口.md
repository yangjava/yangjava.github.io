---
layout: post
categories: [Java]
description: none
keywords: Java
---
# Ip地址查询接口
IP地址库查询接口，根据IP地址或经纬度查询归属地/州/国家/省市区/经纬度及网络运营商ISP等信息。

## 最新可用ip地址查询接口
- 网易云接口 http://ip.ws.126.net/ipquery?ip=[IP地址]
- 淘宝 http://ip.taobao.com/service/getIpInfo.php?ip=115.159.152.210
- 新浪 http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=js&ip=115.159.152.210
- 搜狐接口 http://pv.sohu.com/cityjson?ie=utf-8
- 爱奇艺接口 http://ip.geo.iqiyi.com/cityjson?format=json&ip=[IP地址]
- ip-api http://ip-api.com/json/[IP地址]?lang=zh-CN
- ip508 http://www.ip508.com/ip?q=115.159.152.210
- 太平洋电脑网接口 http://whois.pconline.com.cn/ipJson.jsp?ip=[IP地址]&json=true
- 腾讯接口 https://apis.map.qq.com/ws/location/v1/ip?output=jsonp&key=KUQBZ-FYDCU-YMVVN-2DDW5-7WDYE-5JBJR&ip=[IP地址]&callback=jQuery18301852690032249129_1600324416562&_=1600324417180
- 携程 https://cdid.c-ctrip.com/model-poc2/h
- ip.cn https://www.ip.cn/api/index?ip=&type=0
- dreamwq https://api.dreamwq.com/api/getLocation
- 此网站获取到的数据比较详细，推荐。 http://www.hao7188.com/
- 比较知名的IP查询网站 http://www.ip.cn/
- 来自台湾的IP查询网站 http://myip.com.tw/
- 万网获取本地公网IP地址 http://www.net.cn/static/customercare/yourip.asp
- 腾讯IP分享计划 http://ip.qq.com/
- 此网站获取到的数据比较详细，推荐。 http://www.hao7188.com/
- 此网站获取到的数据比较详细，推荐。 http://www.hao7188.com/
以下还有些收费的API接口(不推荐)：
- 百度地图高精度定位API：http://lbsyun.baidu.com/index.php?title=webapi/high-acc-ip
- 百度的API：http://apistore.baidu.com/apiworks/servicedetail/114.html
- NowAPI：https://www.nowapi.com/api/ip.get
- 91查API：http://www.91cha.com/api/ip.html

## 参考示例代码
```java
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Component;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;

import javax.annotation.Resource;

@Component
@Slf4j
public class IpService {

    @Resource
    private RestTemplateBuilder builder;

    private final static String IP_URL = "http://whois.pconline.com.cn/ipJson.jsp?json=true&ip=${ip}";

    @Cacheable(value = {"ipCache"},key = "#p0")
    public String getIp(String ip) {
        //参数
        MultiValueMap<String, Object> param = new LinkedMultiValueMap<String, Object>();
        param.add("ip", ip);
        String result2 = builder.build().getForObject(IP_URL, String.class, param);
        log.info("获取IP地址=>{},{}",ip,result2);
        return result2;
    }
}
```

## 离线IP地址定位库
ip2region - 准确率99.9%的离线IP地址定位库，0.0x毫秒级查询，ip2region.db数据库只有数MB，提供了java、php、c、python、nodejs、golang、c#等查询绑定和Binary,B树,内存三种查询算法。

引入依赖
```xml
<dependency>
     <groupId>org.lionsoul</groupId>
     <artifactId>ip2region</artifactId>
     <version>2.7.0</version>
 </dependency>
```

下载ip2region.db
这个可以在gitee仓库（https://gitee.com/lionsoul/ip2region）下载，在项目的data目录下。

使用方式（完全基于文件的查询）
```
import org.lionsoul.ip2region.xdb.Searcher;
import java.io.*;
import java.util.concurrent.TimeUnit;

public class SearcherTest {
    public static void main(String[] args) {
        // 1、创建 searcher 对象
        String dbPath = "ip2region.xdb file path";
        Searcher searcher = null;
        try {
            searcher = Searcher.newWithFileOnly(dbPath);
        } catch (IOException e) {
            System.out.printf("failed to create searcher with `%s`: %s\n", dbPath, e);
            return;
        }

        // 2、查询
        try {
            String ip = "1.2.3.4";
            long sTime = System.nanoTime();
            String region = searcher.search(ip);
            long cost = TimeUnit.NANOSECONDS.toMicros((long) (System.nanoTime() - sTime));
            System.out.printf("{region: %s, ioCount: %d, took: %d μs}\n", region, searcher.getIOCount(), cost);
        } catch (Exception e) {
            System.out.printf("failed to search(%s): %s\n", ip, e);
        }

        // 3、关闭资源
        searcher.close();
        
        // 备注：并发使用，每个线程需要创建一个独立的 searcher 对象单独使用。
    }
}
```

我们也可以预先加载整个 ip2region.xdb 的数据到内存，然后基于这个数据创建查询对象来实现完全基于文件的查询，类似之前的 memory search。
```
import org.lionsoul.ip2region.xdb.Searcher;
import java.io.*;
import java.util.concurrent.TimeUnit;

public class SearcherTest {
    public static void main(String[] args) {
        String dbPath = "ip2region.xdb file path";

        // 1、从 dbPath 加载整个 xdb 到内存。
        byte[] cBuff;
        try {
            cBuff = Searcher.loadContentFromFile(dbPath);
        } catch (Exception e) {
            System.out.printf("failed to load content from `%s`: %s\n", dbPath, e);
            return;
        }

        // 2、使用上述的 cBuff 创建一个完全基于内存的查询对象。
        Searcher searcher;
        try {
            searcher = Searcher.newWithBuffer(cBuff);
        } catch (Exception e) {
            System.out.printf("failed to create content cached searcher: %s\n", e);
            return;
        }

        // 3、查询
        try {
            String ip = "1.2.3.4";
            long sTime = System.nanoTime();
            String region = searcher.search(ip);
            long cost = TimeUnit.NANOSECONDS.toMicros((long) (System.nanoTime() - sTime));
            System.out.printf("{region: %s, ioCount: %d, took: %d μs}\n", region, searcher.getIOCount(), cost);
        } catch (Exception e) {
            System.out.printf("failed to search(%s): %s\n", ip, e);
        }
        
        // 4、关闭资源 - 该 searcher 对象可以安全用于并发，等整个服务关闭的时候再关闭 searcher
        // searcher.close();

        // 备注：并发使用，用整个 xdb 数据缓存创建的查询对象可以安全的用于并发，也就是你可以把这个 searcher 对象做成全局对象去跨线程访问。
    }
}
```

封装IPUtils工具类
```
import lombok.extern.slf4j.Slf4j;
import org.lionsoul.ip2region.xdb.Searcher;
import org.springframework.core.io.ClassPathResource;
import org.springframework.util.FileCopyUtils;

import java.io.InputStream;

/**
 * IP城市定位
 */
@Slf4j
public class IPUtils {
    private static Searcher searcher;

    /**
     * 获取城市信息（从ip2region.db中获取地理位置）
     */
    public static String getCityInfo(String ip) {
        try {
            return searcher.search(ip);
        } catch (Exception e) {
            log.error("failed to search({})", ip, e);
        }
        return null;
    }

    static {
        try {
            InputStream inputStream = new ClassPathResource("/ip2region.xdb").getInputStream();
            byte[] dbBinStr = FileCopyUtils.copyToByteArray(inputStream);
            // 创建一个完全基于内存的查询对象
            searcher = Searcher.newWithBuffer(dbBinStr);
        } catch (Exception e) {
            log.error("failed to create content cached searcher", e);
        }
    }

    public static void main(String[] args) {
        System.out.println(getCityInfo("1.80.0.0"));
    }
}
```

也可以这样，在服务启动时加载 ip2region.db 到内存中，如下代码：
```
@PostConstruct
private static void initIp2regionResource() {
    try {
        InputStream inputStream = new ClassPathResource("/ip2region.xdb").getInputStream();
        byte[] dbBinStr = FileCopyUtils.copyToByteArray(inputStream);
        // 创建一个完全基于内存的查询对象
        searcher = Searcher.newWithBuffer(dbBinStr);
    } catch (Exception e) {
        log.error("failed to create content cached searcher", e);
    }
}
```








