---
layout: post
categories: [JSON,FastJSON]
description: none
keywords: FastJSON
---
# FastJSON详解

## Fastjson主要的类和API
在包中，可以发现主要的3个类，JSON,JSONArray，JSONObject。三者之间的关系如下，JSONObject和JSONArray继承JSON。

可以发现，
- JSONObject代表json对象，
- JSONArray代表json对象数组，
- JSON代表JSONObject和JSONArray的转化。

Fastjson的主要入口类是com.alibaba.fastjson.JSON 主要的API是JSON.toJSONString 和parseObject。

使用场景

序列化
```
String jsonString = JSON.toJSONString(obj);
```

反序列化
```
VO vo = JSON.parseObject("…", VO.class);
```
泛型反序列化
```
import com.alibaba.fastjson.TypeReference; 

List list = JSON.parseObject("…", new TypeReference<List>() {});
```


## SpringBoot引入FastJSON
springboot默认使用jackson作为json解析器，所以需要剔除这部分的依赖。
```xml
    <properties>
        <fastjson.version>2.0.6</fastjson.version>
    </properties>

<dependencies>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    <!-- 剔除jackson -->
    <exclusions>
        <exclusion>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-json</artifactId>
        </exclusion>
    </exclusions>
</dependency>

<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>${fastjson.version}</version>
</dependency>
</dependencies>
```

### fastjson配置
我们查询数据时，查询出的数据很可能是一个null值，对于json来说null值并不友好，所以我们需要进一步处理null值。

因为fastjson对null处理需要重写WebMvcConfigurationSupport中的configureMessageConverters方法，所以我们在使用前进行配置。
```java
import com.alibaba.fastjson.serializer.SerializerFeature;
import com.alibaba.fastjson.support.config.FastJsonConfig;
import com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.MediaType;
import org.springframework.http.converter.HttpMessageConverter;

import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.List;

@Configuration
public class FastJSONConfig {

    @Bean
    public HttpMessageConverter configureMessageConverters() {
        FastJsonHttpMessageConverter converter = new FastJsonHttpMessageConverter();
        FastJsonConfig config = new FastJsonConfig();
        config.setSerializerFeatures(
                // 保留map空的字段
                SerializerFeature.WriteMapNullValue,
                // 将String类型的null转成""
                SerializerFeature.WriteNullStringAsEmpty,
                // 将Number类型的null转成0
                SerializerFeature.WriteNullNumberAsZero,
                // 将List类型的null转成[]
                SerializerFeature.WriteNullListAsEmpty,
                // 将Boolean类型的null转成false
                SerializerFeature.WriteNullBooleanAsFalse,
                // 避免循环引用
                SerializerFeature.DisableCircularReferenceDetect);

        converter.setFastJsonConfig(config);
        converter.setDefaultCharset(StandardCharsets.UTF_8);
        List<MediaType> mediaTypeList = new ArrayList<>();
        // 解决中文乱码问题，相当于在Controller上的@RequestMapping中加了个属性produces = "application/json"
        mediaTypeList.add(MediaType.APPLICATION_JSON);
        converter.setSupportedMediaTypes(mediaTypeList);
        return converter;
    }
}

```


## 源码解析
观察该类的继承与实现关系，不难发现，JSONObject实现了Map接口，而json对象中的数据都是以"键：值"对形式出现，可以猜想，JSONObject底层操作是由Map实现的。

类中主要是get()方法。因为JSONObject相当于json对象，所以该类中主要封装了各种get方法，通过"键：值"对中的键来获取其对应的值。且方法的输入参数几乎皆为String类型，这是因为json对象中，"键：值"对的键都是String类型的。来看一下平时用到较多的 。

- getString(String key)
getString(String key)方法，该方法输入参数为String key（键），输出为String ，用于获取json对象中的字符串型数据。例如通过该方法获取 “name”："bob"键值对中name这个键所对应的值bob。
发现内部主要由Map接口中的get()方法实现。

- getInteger(String key)
再去看JSONObject中另一个常用的方法getInteger(String key)，该方法获取json对象中的整型数据，例如获取"age：20"键值对中age对应的整型数值20.

对比getString(String key)方法，两者极为相似，都是通过Map接口的get()方法实现。

总结：JSONObject对应json对象，通过各种形式的get()方法可以获取json对象中的数据，也可利用诸如size()，isEmpty()等方法获取"键：值"对的个数和判断是否为空。其本质是通过实现Map接口并调用接口中的方法完成的。

### JSONArray
观察JSONArray的继承与实现，并结合上面对JSONObject的分析，不难发现，其内部是由List接口中的方法来完成操作的。
同样观察JSONArray类中的方法，由于方法较多，下面分为两部分

JSONArray代表json对象数组，json数组对象中存储的是一个个json对象，所以类中的方法主要用于直接操作json对象。比如这其中的add(),remove()，containsAll()方法，对应于json对象的添加，删除与判断。其内部主要有List接口中的对应方法来实现。

跟JSONObject一样，JSONArray里面也有一些get()方法，不过都不常用，最有用的应该是getJSONObject(int index)方法，该方法用于获取json对象数组中指定位置的JSONObject对象，配合size()方法，可用于遍历json对象数组中的各个对象。
接下来

通过以上两个方法，在配合for循环，即可实现json对象数组的遍历，当然JSONArray中也实现了迭代器方法来遍历，这和List的遍历极为相似。

通过遍历得到JSONObject对象，然后再利用JSONObject类中的get()方法，即可实现最终json数据的获取！！！

### JSON类
最后一个，也是最重要的一个类JSON类。之所以把这个放在最后，是因为这个类主要是实现转化用的，最后的数据获取，还是要通过上面的JSONObject和JSONArray来实现。

仔细观察这些方法，主要是实现json对象，json对象数组，javabean对象，json字符串之间的相互转化。
toJSONString ()

该方法经过多次重载，但最终都是实现json对象转化为json字符串和javabean对象转化为json 字符串。其中，有关键字transient修饰的toJSONString()用于json对象序列化过程中，希望某个"键：值"对数据不变的应用中。

parseObject()

JSON类之parseObject()方法，实现json字符串转换为json对象或javabean对象

该方法返回JSONObject对象，用于实现json字符串向json对象的转化，其内部调用了parse()方法，调用底层的DefaultJSONParser解析类进行转化，在转化失败时，抛出can not cast to JSONObject异常。

该方法不仅能实现json字符串向json对象的转化,经过重载之后，还能实现json字符串向javabean对象的转化

使用
json字符串与javaBean之间的转换可以使用 TypeReference 这个类，也可以使用Class这个类。

Student stu1=JSON.parseObject(jsonstr,new TypeReference(){});
Student stu1=JSON.parseObject(jsonstr,Student.class);

我推荐使用第二种Class类反射来实现，比较简单。

JSON类之JSONArray()方法，实现json字符串转化为json对象数组或List

与parseObject()方法类似，parseArray()将json字符串转化为json对象数组或转化成包含泛型的List

JSON类之toJSON()方法，实现javabean对象转化为json对象

该方法用的比较少，主要用于将javabean对象转化为json对象，内部通过Map，LinkedHashMap，HashMap等集合接口实现。

该方法也经过重载，通过TypeReference类和Class类反射来实现，主要讲json对象转化为javabean对象，用的也比较少。

将对象中的空值输出
在fastjson中，缺省是不输出空值的。无论Map中的null和对象属性中的null，序列化的时候都会被忽略不输出，这样会减少产生文本的大小。但如果需要输出空值怎么做呢？

如果你需要输出空值，需要使用 SerializerFeature.WriteMapNullValue

Model obj = …;
JSON.toJSONString(obj, SerializerFeature.WriteMapNullValue);

class Model {
public List items;
}

Model obj = …;

String text = JSON.toJSONString(obj, SerializerFeature.WriteNullBooleanAsFalse);






