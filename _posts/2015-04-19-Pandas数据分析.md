---
layout: post
categories: [Python,Pandas]
description: none
keywords: Python,Pandas
---
# Pandas
Pandas是一个基于NumPy的分析结构化数据的工具集，NumPy为其提供了高性能的数据处理能力。Pandas被普遍用于数据挖掘和数据分析，同时也提供数据清洗、数据I/O、数据可视化等辅助功能。

## Pandas简介
作为Python科学计算的基础软件包，NumPy已经足够强大，却不够完美，因为NumPy不支持异构列表格数据。异构列表格数据是指在一个二维数据结构中允许不同的列拥有不同的数据类型。
尽管NumPy支持任意维度的数据结构，但在实际工作中，无论是传统软件开发领域还是机器学习领域，使用的数据大多数都是二维异构列表格数据。Pandas正是为处理此类数据而生的，它为处理和SQL或Excel表类似的异构列表格数据提供了灵活、便捷的数据结构，从而迅速成为Python 的核心数据分析支持库。

Pandas是Python生态环境下非常重要的数据分析包，它是一个开源的、有BSD开源协议的库。正因为有它的存在，基于Python的数据分析才能大放异彩，为世人所瞩目。

Pandas吸纳了NumPy中的很多精华，然在数据分析方面“青出于蓝而胜于蓝”。二者最大的不同在于，Pandas在设计之初就是倾向于支持图表和混杂数据运算的，相比之下，NumPy显得“纯洁”很多，它是基于数组构建的，NumPy中的数组一旦被设置为某种数据类型（如整型或浮点型），就会从一而终，不得改变。

Pandas是基于NumPy构建的数据分析包，但它含有比ndarray更为高级的数据结构和操作工具，如Series类型、DataFrame类型等。有了这些高级数据的辅佐，使得通过Pandas进行数据分析变得更加便捷与高效。Pandas除了可以通过管理索引来快速访问数据、执行分析和转换运算，还可用于高效绘图，只需寥寥几行代码，一个栩栩如生的数据可视化图便可“扑面而来”（当然，它用了Matplotlib 作为后端支持）。

此外，Pandas还是数据读取“小能手”，支持从多种数据存储文件（如CSV、TXT、Excel、HDF5等）中读取数据，支持从数据库（如SQL）中读取数据，还支持从Web（如JSON、HTML等）中读取数据。

85后的韦斯·麦金尼（Wes McKinney）于2009年发布了Pandas的第一个版本，此后这个项目一直在缓慢地自我迭代。在2020年，Pandas已迈入1.0时代。

Pandas的使用便捷，离不开高效的底层数据结构的支持。Pandas主要有三种数据结构：Series（类似于一维数组）、DataFrame（类似于二维数组）和Panel（类似于三维数组）。由于Panel并不常用，因此，新版本的Pandas已经将其列为过时（Deprecated）的数据结构。

## 安装和使用
Pandas可以使用pip命令直接安装，安装命令如下。如果默认的模块安装源下载速度慢，可以使用-i参数选择下载速度更快的清华、阿里、中科大等镜像源。
```shell
python -m pip install pandas
```
因为NumPy是Pandas的依赖包，如果当前系统没有安装NumPy，上面的安装命令还会自动安装最新版本的NumPy模块。类似导入NumPy模块时使用简写，导入Pandas模块时，pandas通常都会简写为pd，这几乎成为程序员们约定俗成的规则。
```shell
>>> import pandas as pd
>>> idx = ['2020','2019','2018']
>>> colname = ['北京','广州','上海','杭州']
>>> data = [[35200.00, 30500.00,31800.00,26300.00],
    [35500.00,31300.00,32200.00,28100.00],
    [34900.00,29600.00,30100.00,24700.00]]
>>> df = pd.DataFrame(data, columns=colname, index=idx)
>>> df
       北京       广州       上海       杭州
2020  35200.0  30500.0  31800.0  26300.0
2019  35500.0  31300.0  32200.0  28100.0
2018  34900.0  29600.0  30100.0  24700.0
```
上面的代码构建了一个带标签的二维数据表格。北京、广州、上海、杭州是每列数据的标签，所有列的标签称为列名；2020、2019、2018是每一行数据的标签，所有行的标签称为索引。
这个带标签的二维数据表格就是Pandas最核心的数据结构DataFrame，所有关于Pandas的操作和技巧几乎都是针对DataFrame这个结构的。

## Pandas的特点
Pandas诞生于2008年，最初是专为金融、统计领域的数据处理者而非程序员量身定制的，其以符合使用者思维习惯的方式提供了几乎所有可能需要的功能。
Pandas追求的目标是尽可能屏蔽所有软件工程的概念，仅保留数据的物理属性和逻辑。例如：用户无须了解HTTP协议和HTML解析技术，只需一行代码即可实现网络数据的抓取和解析，其代码形式如下。
```shell
>>> data = pd.read_html('http://www.nssdc.ac.cn/')
>>> data[1]
                     0                       1
0  2020年3月3日发布嫦娥四号首批科学数据    2020-03-03
1  HXMT首批观测数据                     2019-04-10
2  2018年9月19日发布地磁Dst指数数据集      2018-09-20
3  2018年9月7日发布地磁Ap指数数据集        2018-09-20
4  2018年8月27日发布地磁Kp指数数据集       2018-09-20
```
但是，对用户过分的“迁就和溺爱”其实是一把双刃剑。正如Pandas之父Wes McKinney（韦斯·麦金尼）所说，Pandas正在背离他最初所期望的简洁和易用，变得越来越臃肿和不可控制。我非常认同Wes McKinney的观点，甚至觉得当Pandas“抛弃”了panel这个概念时，就已经“走火入魔”了。panel是Pandas最初为处理更高维数据提出的方案，非常接近HDF或netCDF的理念。后来Pandas使用“层次化索引”来处理更高维数据，导致其结构趋于复杂，使得程序员无法专注于事务逻辑的处理。

不过，瑕不掩瑜，虽然因此让人感到有点遗憾，但这也难掩Pandas的光芒。Pandas不只是简洁，还拥有出众的数据处理能力和完备的辅助功能。归纳起来，Pandas有以下5大特点。
- 具有极强的自适应能力。无论是Python还是NumPy的数据对象，即使是结构不规则的数据也可以轻松转换为DataFrame。Pandas还可以自动处理缺失数据，类似NumPy的掩码数组。
- NumPy为其提供了快速的数据组织和处理能力。Pandas支持任意增删数据列，支持合并、连接、重塑、透视数据集，支持聚合、转换、切片、花式索引、子集分解等操作。
- 完善的时间序列。Pandas支持日期范围生成、频率转换、移动窗口统计、移动窗口线性回归、日期位移等时间序列功能。
- 拥有全面的I/O工具。Pandas支持读取文本文件（CSV等支持分隔符的文件）、Excel文件、HDF文件、SQL表数据、json数据、html数据，甚至可以直接从url下载并解析数据，也可以将数据保存为CSV文件或Excel文件。
- 对用户友好的显示格式。不管数据复杂程度如何，Pandas展现出的数据结构总是最清晰的，它支持自动对齐对象和标签，必要时也可以忽略标签。

## Pandas的数据结构
学习Pandas的最佳方式是从了解它的数据结构开始。有些人说，Pandas很简单，只有Series和DataFrame两种数据结构。
但是不管是Series还是DataFrame，它们都有一个索引Index，Index也是Pandas基本的数据结构之一。
### 索引Index
索引类似一维数组，在Pandas的其他数据结构中作为标签使用。虽然不了解索引的信息也可以使用Pandas，但要想精通Pandas，深刻理解索引（如层次化索引MultiIndex）是非常有必要的。
```shell
>>> pd.Index([3,4,5])
Int64Index([3, 4, 5], dtype='int64')
>>> pd.Index(['x','y','z'])
Index(['x', 'y', 'z'], dtype='object')
>>> pd.Index(range(3))
RangeIndex(start=0, stop=3, step=1)
>>> idx = pd.Index(['x','y','z'])
```

使用数组、列表、迭代器等都可以创建索引。索引看起来像一维数组，但无法修改元素的值。这一点非常重要，只有这样才能保证多个数据结构之间的安全共享。

实际上，索引有很多种类型，除了一维索引数据组，还有时间纳秒级戳索引、层次化索引等。此外，索引也有删除、插入、连接、交集、并集等操作。

### 带标签的一维同构数组Series
Series是由一组同一类型的数据和一组与数据对应的标签（Index）组成的数据结构，数据对应的标签又称为索引，索引是允许重复的。Pandas提供了多种生成Series的方式。

以下代码使用整型列表和字符串列表创建了两个Series。因为没有指定索引，Series生成器自动添加了默认索引。默认索引是从0开始的整型序列。
```shell
>>> pd.Series([0,1,2]) # 用列表生成Series，使用默认索引
0    0
1    1
2    2
dtype: int64
>>> pd.Series(['a','b','c']) # 用列表生成Series，使用默认索引
0    a
1    b
2    c
dtype: object
```

创建Series时，也可以同时指定索引。不过，索引长度一定要和列表长度相等，否则会抛出异常。另外，Series生成器也接受迭代对象作为参数。
```shell
>>> pd.Series([0,1,2], index=['a','b','c']) # 用列表生成Series
a    0
b    1
c    2
dtype: int64
>>> pd.Series(range(3), index=list('abc')) # 用迭代对象生成Series
a    0
b    1
c    2
dtype: int64
```

使用字典创建Series时，如果没有指定索引，则使用字典的键作为索引；如果指定了索引，则不要求和字典的键匹配。
```shell
>>> pd.Series({'a':1,'b':2,'c':3}) # 用字典生成Series，使用字典的键做索引
a    1
b    2
c    3
dtype: int64
>>> pd.Series({'a':1,'b':2,'c':3}, index=list('abxy')) # 指定索引
a    1.0
b    2.0
x    NaN
y    NaN
dtype: float64
```

Series有很多属性和方法，其中大部分和NumPy类似，甚至完全一致。这些属性和方法会在后面的应用中被用到，初学者现阶段了解下面这三个属性即可。
```shell
>>> s = pd.Series({'a':1,'b':2,'c':3})
>>> s.dtype # Series的数据类型是最重要的三个属性之一
dtype('int64')
>>> s.values # Series的数组是最重要的三个属性之二
array([1, 2, 3], dtype=int64)
>>> s.index # Series的索引是最重要的三个属性之三
Index(['a', 'b', 'c'], dtype='object')
```

深刻理解Series需要牢记两点：第一，Series的所有数据都是同一种数据类型，也就是一个Series一定有一个数据类型；第二，Series的每一个数据对应一个索引，但索引是允许重复的。

### 带标签的二维异构表格DataFrame
DataFrame可以看作由多个Series组成的二维表格型数据结构。每一个Series作为DataFrame的一列，每一列都有一个列名，都可以拥有独立的数据类型，所有的Series共用一个索引。列名称为DataFrame的列标签，索引称为DataFrame的行标签。

需要说明一点，DataFrame虽然是二维结构的，但并不意味着它不能处理更高维度的数据。事实上，依赖层次化索引，DataFrame可以轻松处理高维度数据。

创建DataFrame的方法有多种。例如，二维NumPy数组或掩码数组，由数组、列表、元组、字典、Series等组成的字典或列表等，甚至是DataFrame，都可以转换为DataFrame。对于结构不规则的数据，也可以轻松转换，因为DataFrame生成器拥有极强的容错能力。

将字典转换为DataFrame是最常见的创建方法，字典的键对应DataFrame的列，键名自动称为列名。如果没有指定索引，则使用默认索引。
```shell
>>> data = {
'华东科技': [1.91, 1.90, 1.86, 1.84],
'长安汽车': [11.27, 11.14, 11.28, 11.71],
'紫金矿业': [7.89, 7.79, 7.61, 7.50],
'重庆啤酒': [50.46, 50.17, 50.28, 50.28]
}
>>> pd.DataFrame(data)
华东科技   长安汽车  紫金矿业   重庆啤酒
0  1.91      11.27    7.89      50.46
1  1.90      11.14    7.79      50.17
2  1.86      11.28    7.61      50.28
3  1.84      11.71    7.50      50.28
```

创建DataFrame时可以指定索引。这里直接使用日期字符串做索引，正确的做法是使用日期索引对象，其代码如下。
```shell
>>> idx = ['2020-03-10','2020-03-11','2020-03-12','2020-03-13']
>>> pd.DataFrame(data, index=idx)
华东科技   长安汽车  紫金矿业   重庆啤酒
2020-03-10  1.91      11.27    7.89      50.46
2020-03-11  1.90      11.14    7.79      50.17
2020-03-12  1.86      11.28    7.61      50.28
2020-03-13  1.84      11.71    7.50      50.28
```

在创建DataFrame时，即使数据以字典形式提供，也可以指定列标签，DataFrame生成器不要求列标签和字典的键全部匹配。对于不存在的键，DataFrame生成器会自动填补NaN值。
```shell
>>> data = {
'华东科技': [1.91, 1.90, 1.86, 1.84],
'长安汽车': [11.27, 11.14, 11.28, 11.71],
'紫金矿业': [7.89, 7.79, 7.61, 7.50],
'重庆啤酒': [50.46, 50.17, 50.28, 50.28]
}
>>> idx = ['2020-03-10','2020-03-11','2020-03-12','2020-03-13']
>>> colnames = ['华东科技', '长安汽车', '杭钢股份', '紫金矿业', '重庆啤酒']
>>> pd.DataFrame(data, columns=colnames, index=idx)
华东科技   长安汽车 杭钢股份  紫金矿业   重庆啤酒
2020-03-10  1.91      11.27   NaN      7.89      50.46
2020-03-11  1.90      11.14   NaN      7.79      50.17
2020-03-12  1.86      11.28   NaN      7.61      50.28
2020-03-13  1.84      11.71   NaN      7.50      50.28
```

二维数组或列表也可以直接转换成DataFrame，同时可以指定索引和列标签。如果没有指定索引或列标签，DataFrame生成器则会自动添加从0开始的索引对象作为索引或列标签。
```shell
>>> data = np.array([
[ 1.91, 11.27,  7.89, 50.46],
[ 1.9 , 11.14,  7.79, 50.17],
[ 1.86, 11.28,  7.61, 50.28],
[ 1.84, 11.71,  7.5 , 50.28]
])
>>> idx = ['2020-03-10','2020-03-11','2020-03-12','2020-03-13']
>>> colnames = ['华东科技', '长安汽车', '紫金矿业', '重庆啤酒']
>>> pd.DataFrame(data, columns=colnames, index=idx)
华东科技   长安汽车  紫金矿业   重庆啤酒
2020-03-10  1.91      11.27    7.89      50.46
2020-03-11  1.90      11.14    7.79      50.17
2020-03-12  1.86      11.28    7.61      50.28
2020-03-13  1.84      11.71    7.50      50.28
```

DataFrame可以看作多个Series的集合，每个Series都可以拥有各自独立的数据类型，因此，DataFrame没有自身唯一的数据类型，自然也就没有dtype属性了。不过，DataFrame多了一个dtypes属性，这个属性的类型是Series类。除了dtypes属性，DataFrame的values属性、index属性、columns属性也都非常重要，需要牢记在心。
```shell
>>> df = pd.DataFrame(data, columns=colnames, index=idx)
>>> df.dtypes # dtypes属性，是由所有列的数据类型组成的Series
华东科技    float64
长安汽车    float64
紫金矿业    float64
重庆啤酒    float64
dtype: object
>>> df.values # DataFrame的重要属性之一
array([[ 1.91, 11.27,  7.89, 50.46],
[ 1.9 , 11.14,  7.79, 50.17],
[ 1.86, 11.28,  7.61, 50.28],
[ 1.84, 11.71,  7.5 , 50.28]])
>>> df.index # DataFrame的重要属性之一
DatetimeIndex(['2020-03-10', '2020-03-11', '2020-03-12', '2020-03-13'],
dtype='datetime64[ns]', freq=None)
>>> df.columns # DataFrame的重要属性之一
Index(['华东科技', '长安汽车', '紫金矿业', '重庆啤酒'], dtype='object')
```















