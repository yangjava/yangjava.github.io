---
layout: post
categories: [Neo4j]
description: none
keywords: Neo4j
---
# Neo4j应用
Neo4j是用Java开发的，可以直接使用Neo4j API。开始使用Neo4j数据库，我们就从嵌入式的Neo4j开始吧，因为它不用安装服务器，只要引用Neo4j的开发包就能正常使用Neo4j了。

## Neo4j数据库访问
- 嵌入式数据库
- 服务器模式(通过REST的访问)
它是由应用程序的性质（neo4j是独立服务器 还是和程序在一起),性能，监控和数据安全性来决定架构选择。

## 使用嵌入式数据库
使用嵌入式的Neo4j，只要在程序中打开一个文件目录，就可以用它作为Neo4j的数据库。通过使用文件方式打开Neo4j数据库。在程序运行时，将在工程的target目录中创建数据库文件目录，并生成一些数据文件。
```xml
<dependency>
	<groupId>org.neo4j</groupId>
	<artifactId>neo4j</artifactId>
	<version>3.5.5</version>
</dependency>
```
使用Neo4j数据库代码
```java
import org.neo4j.graphdb.*;
import org.neo4j.graphdb.factory.GraphDatabaseFactory;
import org.springframework.stereotype.Component;

import java.io.File;
import java.util.HashMap;
import java.util.Map;
@Component
public class GraphService {
    
    public void AddNeo4j() {
        File databaseDirectory = new File("target/graph.db");
        GraphDatabaseService graphDb = new GraphDatabaseFactory().newEmbeddedDatabase(databaseDirectory);
        System.out.println("Database Load!");
        Transaction tx = graphDb.beginTx();
        Node n1 = graphDb.createNode();
        n1.setProperty("name", "张三");
        n1.setProperty("character", "A");
        n1.setProperty("gender", 1);
        n1.setProperty("money", 1101);
        n1.addLabel(new Label() {
            @Override
            public String name() {
                return "Person";
            }
        });
        String cql = "CREATE (p:Person{name:'李四',character:'B',gender:1,money:21000})";
        graphDb.execute(cql);
        tx.success();
        tx.close();
        System.out.println("Database Shutdown!");
        graphDb.shutdown();
    }

    public void queryNeo4jAll() {
        File databaseDirectory = new File("target/graph.db");
        GraphDatabaseService graphDb = new GraphDatabaseFactory().newEmbeddedDatabase(databaseDirectory);
        System.out.println("Database Load!");
        String cql = "MATCH (a:Person) where a.money < $money return a";
        Map<String, Object> paramerters = new HashMap<String, Object>();
        paramerters.put("money", 25000);
        Transaction tx = graphDb.beginTx();
        Result result = graphDb.execute(cql, paramerters);
        while (result.hasNext()) {
            Map<String, Object> row = result.next();
            for (String key : result.columns()) {
                Node nd = (Node) row.get(key);
                System.out.printf("%s = %s:%s%n", key,
                        nd.getProperty("name"), nd.getProperty("money"));
            }
        }
        tx.success();
        tx.close();
        System.out.println("Database Shutdown!");
        graphDb.shutdown();
    }
}
```

## Neo4j服务器模式
添加neo4j依赖
```xml
<dependency>
	<groupId>org.neo4j</groupId>
	<artifactId>neo4j-ogm-bolt-driver</artifactId>
	<version>3.2.10</version>
</dependency>
```
下面通过一个简单的测试程序来演示如何使用Neo4j API连接Neo4j服务器，以实现数据的存取操作。
```java
import org.neo4j.driver.*;

import static org.neo4j.driver.Values.parameters;

public class GraphServer {

    public void matchServer(){
        Driver driver = GraphDatabase.driver( "bolt://127.0.0.1:7687",
                AuthTokens.basic( "neo4j", "123456" ) );
        Session session = driver.session();
        String cql = "MATCH (a:Person) WHERE a.money > $money " +
                "RETURN a.name AS name, a.money AS money order by a.money ";
        Result result = session.run( cql,parameters( "money", 1000 ) );
        while ( result.hasNext() )
        {
            Record record = result.next();
            System.out.println( record.get( "name" ).asString() + " " +
                    record.get( "money" ).asDouble() );
        }
        session.close();
        driver.close();
    }

    public void pathServer(){
        Driver driver = GraphDatabase.driver( "bolt://127.0.0.1:7687",AuthTokens.basic( "neo4j", "123456" ) );
        Session session = driver.session();
        String cql = "MATCH p=shortestPath((person:Person {name:$startName})-[*]-(person2:Person {name:$endName} )) RETURN p";
        Result result = session.run( cql,parameters("startName","王启年","endName","九品射手燕小乙") );
        while ( result.hasNext() )
        {
            Record record = result.next();
            System.out.println(record);
        }
        session.close();
        driver.close();
    }

}
```

## SpringBoot 整合Neo4j
Maven依赖
```xml
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-data-neo4j</artifactId>
</dependency>
<dependency>
	<groupId>org.neo4j</groupId>
	<artifactId>neo4j-ogm-bolt-driver</artifactId>
</dependency>
```

建立实体类
```java
@NodeEntity
public class Person {
    @Id
    @GeneratedValue
    private Long  id;
    @Property("cid")
    private int   pid;
    private String name;
    private String  character;
    private double  money;
    private int   age;
    private String description;
    @Relationship(type = "Friends",direction = Relationship.OUTGOING)
    private Set<Person>  friendsPerson;


    public Set<Person> getFriendsPerson() {
        return friendsPerson;
    }

    public void setFriendsPerson(Set<Person> friendsPerson) {
        this.friendsPerson = friendsPerson;
    }

    public Person(Long id, int pid, String name, String character, double money, int age, String description) {
        this.id = id;
        this.pid = pid;
        this.name = name;
        this.character = character;
        this.money = money;
        this.age = age;
        this.description = description;
    }

    public Person() {
    }

    public Long getId() {
        return id;
    }

    @Override
    public String toString() {
        return "Person{" +
                "id=" + id +
                ", pid=" + pid +
                ", name='" + name + '\'' +
                ", character='" + character + '\'' +
                ", money=" + money +
                ", age=" + age +
                ", description='" + description + '\'' +
                ", friendsPerson=" + friendsPerson +
                '}';
    }

    public void setId(Long id) {
        this.id = id;
    }

    public int getPid() {
        return pid;
    }

    public void setPid(int pid) {
        this.pid = pid;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getCharacter() {
        return character;
    }

    public void setCharacter(String character) {
        this.character = character;
    }

    public double getMoney() {
        return money;
    }

    public void setMoney(double money) {
        this.money = money;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }
}
```

数据持久层
```java
@Repository
public interface PersonRepository extends Neo4jRepository<Person,Long> {
     /** 查看money 大于指定值的Person 列表 */
     //@Query("match(p:Person) where p.money>{0} return p")
     @Query("match(p:Person) where p.money>{money} return p")
     List<Person>   personList(@Param("money") double money);

     /** 指定开始的名字 和 结束的名字 查询最短路径  限定深度为4以层包含4*/
     @Query("match p=shortestPath((person:Person{name:{startName}})-[*1..4]-(person2:Person {name:{endName}})) return p")
     List<Person>   shortestPath(@Param("startName") String startName,@Param("endName") String endName);
     @Query("match p =(person:Person {name:{name}})-[*1..2]-(:Person) return p")
     List<Person>   personListDept(@Param("name") String name);
}
```

配置文件 application.yml
```yaml
spring:
  data:
    neo4j:
      username: neo4j
      password: 123456
      uri:  bolt://localhost:7687
```





