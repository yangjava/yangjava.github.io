---
layout: post
categories: [MongoDB]
description: none
keywords: MongoDB
---
# MongoDB源码内核网络传输
transport 模块的具体目录文件结构：
整个目录中的源码实现文件大体可以分为如下几个部分：

message_compressor_* 网络传输数据压缩子模块
service_entry_point * 服务入口点子模块
service_executor * 服务运行子模块，即线程模型子模块
service_state_machine * 服务状态机处理子模块
Session * 回话信息子模块
Ticket * 数据分发子模块
transport_layer * 套接字处理及传输层模式管理子模块
通过上面的拆分，整个大的 transport 模块实现就被拆分成了 7 个小模块，这 7 个小的子模块各自负责对应功能实现，同时各个模块相互衔接，整体实现网络传输处理过程的整体实现，下面的章节将就这些子模块进行简单功能说明。

我们把 transport 功能模块细化拆分成了网络传输数据压缩子模块、服务入口子模块、线程模型子模块、状态机处理子模块、session 会话信息子模块、数据分发子模块、套接字处理和传输管理子模块，总共七个子模块。

实际上 mongodb 服务层代码的底层网络 IO 实现依赖 asio 库完成，因此 transport 功能模块应该是 7+1 个子模块构成，也就是服务层代码实现由 8 个子模块支持。

## asio 网络 IO 库实现原理
Asio 是一个优秀网络库，依赖于 boost 库的部分实现，支持 linux、windos、unix 等多平台，mongodb 基于 asio 库来实现网络 IO 及定时器处理。asio 库由于为了支持多平台，在代码实现中用了很多 C++ 的模板，同时用了很多 C++ 的新语法特性，因此整体代码可读性相比 mongodb 服务层代码差很多。

服务端网络 IO 异步处理流程大体如下：

1. 调用 socket () 创建一个套接字，获取一个 socket 描述符。

2. 调用 bind() 绑定套接字，同时通过 listen() 来监听客户端链接，注册该 socket 描述符到 epoll 事件集列表，等待 accept 对应的新连接读事件到来。

3. 通过 epoll_wait 获取到 accept 对应的读事件信息，然后调用 accept() 来接受客户的连接，并获取一个新的链接描述符 new_fd。

4. 注册新的 new_fd 到 epoll 事件集列表，当该 new_fd 描述符上有读事件到来，于是通过 epoll_wait 获取该事件，开始该 fd 上的数据读取。

5. 读取数据完毕后，开始内部处理，处理完后发送对应数据到客户端。如果一次 write 数据到内核协议栈写太多，造成协议栈写满，则添加写事件到 epoll 事件列表。

    服务端网络 IO 同步方式处理流程和异步流程大同小异，少了 epoll 注册和 epoll 事件通知过程，直接同步调用 accept ()、recv ()、send () 进行 IO 处理。

    同步 IO 处理方式相对比较简单，下面仅分析和 mongodb 服务层 transport 模块结合比较紧密的 asio 异步 IO 实现原理。

     Mongodb 服务层用到的 Asio 库功能中最重要的几个结构有 io_context、scheduler、epoll_reactor。Asio 把网络 IO 处理任务、状态机调度任务做为 2 种不同操作，分别由两个继承自 operation 的类结构管理，每种类型的操作也就是一个任务 task。io_context、scheduler、epoll_reactor 最重要的功能就是管理和调度这些 task 有序并且高效的运行。

## io_context 类实现及其作用
io_context 上下文类是 mongodb 服务层和 asio 网络库交互的枢纽，是 mongodb 服务层和 asio 库进行 operation 任务交互的入口。该类负责 mongodb 相关任务的入队、出队，并与 scheduler 调度处理类配合实现各种任务的高效率运行。Mongodb 服务层在实现的时候，accept 新连接任务使用_acceptorIOContext 这个 IO 上下文成员实现，数据分发及其相应回调处理由_workerIOContext 上下文成员实现。


## asio 调度模块 scheduler 实现
上一节的 io_context 上下文中提到 mongodb 操作的 io 上下文最终都会调用 scheduler 的几个核心接口，io_context 只是起衔接 mongodb 和 asio 库的链接桥梁。scheduler 类主要工作在于完成任务调度，该类和 mongodb 相关的几个主要成员变量及接口如下表：

## operation 任务队列
从前面的分析可以看出，一个任务对应一个 operation 类结构，asio 异步实现中 schduler 调度的任务分为 IO 处理任务 (accept 处理、读 io 处理、写 io 处理、网络 IO 处理回调处理) 和全局状态机任务，总共 2 种任务小类。

此外，asio 还有一种特殊的 operation，该 Operastion 什么也不做，只是一个特殊标记。网络 IO 处理任务、状态机处理任务、特殊任务这三类任务分别对应三个类结构，分别是：reactor_op、completion_handler、task_operation_，这三个类都会继承基类 operation。

## 