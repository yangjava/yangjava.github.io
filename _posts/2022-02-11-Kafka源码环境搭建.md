---
layout: post
categories: [Kafka]
description: none
keywords: Kafka
---
# Kafka源码环境搭建

## kafka源码结构介绍
```
bin： 各种执行脚本；

clients：生产者和消费者代码；1.x版本是java语言开发；

config： 运行所需的所有配置文件，包括broker,producer,consumer；

core ： kafka服务实例（broker）的代码，scala语言开发，实现了集群管理，分区副本管理，消息存储和消息获取，网络通信等功能；
	admin包：执行管理命令的功能；
	api 包： 封装请求和响应DTO对象；
	cluster包：集群对象，例如Replica 类代表一个分区副本，Partition类代表一个分区；
	common包： 通用jar包；
	controller包： 和kafkaController（kc）相关的类，重点模块，一个kafka集群只有一个leader kc，该kc负责 分区管理，副本管理，并保证集群信息在集群中同步；
	coordinator包：组协调者相关，负责处理消费者组的代码；
	log包： 磁盘存储相关，重点模块；
	network包： 网络相关，重点模块，使用的是NIO，从这里可学习如何应用java 的NIO类；
	consumer包，producer好多废弃类，无需关注；
	server包： kafka实例的各种管理类，核心包，也是重点；
	tools 工具类。

docs：kakfa文档

examples：生产者消费者demo 启动脚本；

streams：kafka 流相关代码；
```

## broker核心源码core 模块介绍
broker启动流程源码以及涉及的主要core中的模块如下

KafkaServer模块
KafkaServer表示单个Kafka代理的生命周期。

start.sh启动脚本最终调用包装类：kafkaserver类，其包括kafka各个模块细节的调用，处理所有需要的功能,启动和关闭单个Kafka节点。
kafkaserver类介绍
```
startup:用于启动Kafka服务器的单个实例的API。
shutdown：关闭服务器
initZK:初始化ZK
```
requestChannel实现socketserver和kafkaApis间的解耦
逻辑分析：socketserver监听到我们的客户端请求--------》转发给kafkaApis逻辑实现代码-------》调度响应模块处理

## broker启动主要模块介绍
- socketserver
监听9092端口的socket读写请求。首先开启一个Acceptor线程，新的Socket连接成功建立时会将对应的SocketChannel以轮询方式转发给N个Processor线程中的某一个，由其处理接下来SocketChannel的请求，将请求放置在RequestChannel中的请求队列；当Processor线程监听到SocketChannel请求的响应时，会将响应从RequestChannel中的响应队列中取出来并发给客户端
- KafkaRequesThandlePool
从socketserver获取客户端请求然后调用 KafkaApis实现业务逻辑处理，将响应结果返回给requestChannel,再给客户端。
- OffsetManager
偏移量管理模块。对偏移量的保存和读取，offset保存分zk和kafka两种地方，由参数offsets.storage=zookeeper/kafka决定。kafka保存到名为consumer_offsets的topic中。
- TopicConfigManager
topic的配置信息管理模块，副本数等
- KafkaApis
kafka的业务逻辑实现层。各种request的实现类，通过match-case匹配请求类型调用实现逻辑。
- KafkaController
kafka的集群管理模块。通过在zk上注册节点达到监听
- KafkaScheduler
kafka的后台定时任务调度的资源池。主要为logmanager,ReplicaManager,OffsetManager提供资源调度。
- ReplicaManager
副本管理。包括有关副本的Leader和ISR的状态变化、副本的删除、副本的监测等。
- KafkaHealthCheck
集群健康检查，brokers/ids下的节点id进行检测
- logmanager
日志管理模块。脏数据，过期数据删除等，负责提供Broker Server上Topic的分区数据读取和写入功能。
- initZkClient
启动zookeeper模块，管理kafka的元数据
















































