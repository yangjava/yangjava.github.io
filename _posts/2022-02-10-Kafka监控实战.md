---
layout: post
categories: [Kafka]
description: none
keywords: Kafka
---
# Kafka监控实战
Kafka搭建好投入使用后，为了运维更便捷，借助一些管理工具很有必要。

## 常用监控指标
为了了解 Kafka 的运作状态和性能状况需要对 Kafka 进行监控和诊断。通过Kafka提供的监控工具和插件可以诊断出 Kafka 的异常、错误、瓶颈和故障等问题并及时采取对应的措施。

Kafka的度量指标主要有以下三类：
- Kafka服务器（Kafka）指标
- 生产者指标
- 消费者指标

## Broker度量指标
Kafka的服务端度量指标是为了监控broker，也是整个消息系统的核心。因为所有消息都通过kafka broker传递，然后被消费，所以对于broker集群上出现的问题的监控和告警就尤为重要。

broker性能指标有以下三类：
- Kafka本身的指标
- 主机层面的指标
- JVM垃圾回收指标
运行状态可以通过 Kafka 文件夹下的 kafka-server-start.sh 和 kafka-server-stop.sh 脚本来启动和停止 broker。
错误信息可以在 kafkaServer.log 文件中找到。可以使用 tail -f /path/to/kafkaServer.log 命令来跟踪最新日志信息。
同步状态可以通过在 config/server.properties 文件中进行配置来达到最佳表现。

## 生产者度量指标
提交速度可以通过 Kafka 生产者默认的 batch.size 参数来控制，此参数默认值为16KB。可以根据需要调整此参数以达到最佳性能
```
batch.size=32768
```
发送成功率可以通过设置生产者确认级别（acks）参数来实现。可配置的选项包括：
```
ack = 0 (fire and forget), ack = 1 (awaiting for receipt) 
或 
ack = -1 (all)
acks=1
```
错误率可以通过在配置文件中设置 retries 和 retry.backoff.ms 参数来控制，达到重试并逐渐递增时间的目的。如果发生无法恢复的错误，则会返回无法恢复的错误
```
retries=3
retry.backoff.ms=1000
```

## 消费者度量指标
消费速度可以通过设置 fetch.min.bytes 和 fetch.max.bytes 参数来控制，以读取指定数量的字节。建议将 fetch.min.bytes 参数设置得足够大，否则会导致大量短暂的网络请求。
```
fetch.min.bytes=65536
fetch.max.bytes=524288
```
消费成功率可以通过运行多个消息消费者并监控每个消费者的消费进度，以确定 Kafka 是否实时消费每个消息。如果消息消费迟缓，则可以增加消费端的数量或增加消费端读取的批量大小。

失败率可以通过设置消费端的 auto.offset.reset 参数来控制。该参数表示消费者应当在无法从上一个偏移量处读取消息时进行的操作，可以设置为 earliest 或 latest。如果设置为 earliest，消费者将从 Kafka 的起始偏移量开始重新读取。如果设置为 latest，消费者将从另一侧开始读取。